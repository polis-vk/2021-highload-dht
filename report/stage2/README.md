# 2021-highload-dht
Курсовой проект 2021 года [курса](https://polis.mail.ru/curriculum/program/discipline/1257/) "Проектирование высоконагруженных систем" в [Технополис](https://polis.mail.ru).

## Этап 2. Многопоточность (deadline 2021-10-13 23:59:59 MSK)
## Report

### Использование wrk2 для нагрузочного тестирования с заданным rate (стабильная нагрузка) 
#### Type request: [PUT](https://github.com/sdimosik/2021-highload-dht/tree/stage2/wrk/put.lua)
#### Запуск wrk2 для put-запроосов
```
wrk2 -c 16 -t 4 -d 1m -R 10k -L -s wrk/put.lua http://localhost:8080
```
#### Output
```
Running 1m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 1.091ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.058ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.100ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.096ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.06ms  624.37us  16.72ms   78.33%
    Req/Sec     2.64k   214.52     6.22k    79.24%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    0.99ms
 75.000%    1.40ms
 90.000%    1.73ms
 99.000%    2.13ms
 99.900%    8.93ms
 99.990%   13.83ms
 99.999%   15.69ms
100.000%   16.74ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.043     0.000000            1         1.00
       0.438     0.100000        50219         1.11
       0.580     0.200000       100169         1.25
       0.707     0.300000       150032         1.43
       0.844     0.400000       200032         1.67
       0.989     0.500000       250019         2.00
       1.068     0.550000       275043         2.22
       1.149     0.600000       299947         2.50
       1.232     0.650000       325118         2.86
       1.313     0.700000       349864         3.33
       1.400     0.750000       375112         4.00
       1.446     0.775000       387445         4.44
       1.496     0.800000       399911         5.00
       1.550     0.825000       412537         5.71
       1.608     0.850000       424995         6.67
       1.670     0.875000       437454         8.00
       1.701     0.887500       443653         8.89
       1.733     0.900000       449827        10.00
       1.767     0.912500       456150        11.43
       1.802     0.925000       462354        13.33
       1.841     0.937500       468595        16.00
       1.862     0.943750       471716        17.78
       1.884     0.950000       474930        20.00
       1.907     0.956250       478058        22.86
       1.933     0.962500       481168        26.67
       1.963     0.968750       484262        32.00
       1.980     0.971875       485789        35.56
       1.999     0.975000       487377        40.00
       2.019     0.978125       488865        45.71
       2.043     0.981250       490455        53.33
       2.069     0.984375       492040        64.00
       2.085     0.985938       492840        71.11
       2.101     0.987500       493559        80.00
       2.123     0.989062       494372        91.43
       2.147     0.990625       495164       106.67
       2.177     0.992188       495907       128.00
       2.195     0.992969       496292       142.22
       2.219     0.993750       496675       160.00
       2.249     0.994531       497064       182.86
       2.297     0.995313       497459       213.33
       2.407     0.996094       497850       256.00
       2.603     0.996484       498041       284.44
       3.129     0.996875       498237       320.00
       3.865     0.997266       498432       365.71
       4.711     0.997656       498626       426.67
       5.715     0.998047       498821       512.00
       6.359     0.998242       498919       568.89
       6.947     0.998437       499017       640.00
       7.555     0.998633       499115       731.43
       8.263     0.998828       499215       853.33
       9.039     0.999023       499309      1024.00
       9.383     0.999121       499358      1137.78
       9.759     0.999219       499407      1280.00
      10.247     0.999316       499456      1462.86
      10.599     0.999414       499505      1706.67
      11.007     0.999512       499555      2048.00
      11.271     0.999561       499578      2275.56
      11.567     0.999609       499603      2560.00
      11.783     0.999658       499627      2925.71
      12.127     0.999707       499651      3413.33
      12.487     0.999756       499675      4096.00
      12.751     0.999780       499688      4551.11
      12.943     0.999805       499701      5120.00
      13.063     0.999829       499712      5851.43
      13.263     0.999854       499724      6826.67
      13.591     0.999878       499737      8192.00
      13.695     0.999890       499743      9102.22
      13.887     0.999902       499749     10240.00
      14.095     0.999915       499755     11702.86
      14.303     0.999927       499761     13653.33
      14.415     0.999939       499767     16384.00
      14.551     0.999945       499770     18204.44
      14.687     0.999951       499773     20480.00
      14.775     0.999957       499776     23405.71
      15.015     0.999963       499779     27306.67
      15.087     0.999969       499782     32768.00
      15.127     0.999973       499784     36408.89
      15.175     0.999976       499785     40960.00
      15.463     0.999979       499787     46811.43
      15.527     0.999982       499788     54613.33
      15.599     0.999985       499790     65536.00
      15.631     0.999986       499791     72817.78
      15.631     0.999988       499791     81920.00
      15.687     0.999989       499792     93622.86
      15.703     0.999991       499793    109226.67
      15.927     0.999992       499794    131072.00
      15.927     0.999993       499794    145635.56
      15.927     0.999994       499794    163840.00
      16.015     0.999995       499795    187245.71
      16.015     0.999995       499795    218453.33
      16.703     0.999996       499796    262144.00
      16.703     0.999997       499796    291271.11
      16.703     0.999997       499796    327680.00
      16.703     0.999997       499796    374491.43
      16.703     0.999998       499796    436906.67
      16.735     0.999998       499797    524288.00
      16.735     1.000000       499797          inf
#[Mean    =        1.056, StdDeviation   =        0.624]
#[Max     =       16.720, Total count    =       499797]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599925 requests in 1.00m, 38.33MB read
Requests/sec:   9998.66
Transfer/sec:    654.21KB

```

### Async-profiler
#### [Output CPU for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage2/report/stage2/put-cpu.html)
#### [Output ALLOC for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage2/report/stage2/put-alloc.html)
#### [Output LOCK for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage2/report/stage2/put-lock.html)

### Conclusions

1. Сервер выдержал нагрузку в 10к req/ses в течении 1m. И что самое главное flush данных не привёл к 
большой задержке, как в stage1 (Самая большая задержка 16.74ms, когда в stage 1 была 1928ms. Это всё благодаря
параллельному flush)
  
 
2. При профилировании cpu мы видим, что flush у нас находится слева отдельно от основной работы 
нашей LsmDAO. Flush запускается в отдельном потоке и съедает около 3% cpu, что очевидно мало 
по сравнению со stage 1 (20.5%). Так же примерно 3% занимает фоновый compaction в отдельном потоке


3. При профилировании alloc мы видим практическую такую же картину, как и на прошлом этапе


4. При профилировании lock мы видим блокировки от logger'a (около 70%) и 30% от upsert (5 сэмплов).
В нашей реализации всегда будут блокировки, если происходит flush и другой поток захочет сделать flush. 
Нужно дождаться flush от первого потока, а затем уже запускать flush из второго. Но если запроса 
на второй flush не будет во время выполнения первого, то первый выполняет flush полностью параллельно.
Полноценный параллельный flush возможен, если бы в наших записях был timestamp

### Type request: [GET](https://github.com/sdimosik/2021-highload-dht/tree/stage2/wrk/get.lua)
#### Запуск wrk2 для put-запроосов
```
wrk2 -c 16 -t 4 -d 1m -R 10k -L -s wrk/get.lua http://localhost:8080  
```
#### Output
```
Running 1m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 1.129ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.093ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.124ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.037ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.09ms  482.83us  10.42ms   67.95%
    Req/Sec     2.65k   189.34     5.11k    73.80%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.04ms
 75.000%    1.40ms
 90.000%    1.75ms
 99.000%    2.21ms
 99.900%    3.53ms
 99.990%    7.39ms
 99.999%    9.73ms
100.000%   10.43ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.123     0.000000            2         1.00
       0.521     0.100000        50208         1.11
       0.671     0.200000       100321         1.25
       0.792     0.300000       150157         1.43
       0.911     0.400000       199941         1.67
       1.036     0.500000       250109         2.00
       1.102     0.550000       274959         2.22
       1.171     0.600000       300178         2.50
       1.242     0.650000       324918         2.86
       1.317     0.700000       349883         3.33
       1.400     0.750000       374912         4.00
       1.446     0.775000       387416         4.44
       1.497     0.800000       400023         5.00
       1.553     0.825000       412477         5.71
       1.615     0.850000       424992         6.67
       1.682     0.875000       437428         8.00
       1.717     0.887500       443592         8.89
       1.755     0.900000       449889        10.00
       1.795     0.912500       456193        11.43
       1.836     0.925000       462367        13.33
       1.882     0.937500       468618        16.00
       1.906     0.943750       471778        17.78
       1.931     0.950000       474821        20.00
       1.959     0.956250       477960        22.86
       1.989     0.962500       481097        26.67
       2.023     0.968750       484218        32.00
       2.042     0.971875       485752        35.56
       2.063     0.975000       487371        40.00
       2.087     0.978125       488996        45.71
       2.111     0.981250       490460        53.33
       2.141     0.984375       492053        64.00
       2.157     0.985938       492831        71.11
       2.175     0.987500       493627        80.00
       2.197     0.989062       494390        91.43
       2.219     0.990625       495178       106.67
       2.245     0.992188       495929       128.00
       2.261     0.992969       496318       142.22
       2.277     0.993750       496691       160.00
       2.297     0.994531       497111       182.86
       2.319     0.995313       497485       213.33
       2.347     0.996094       497873       256.00
       2.365     0.996484       498065       284.44
       2.385     0.996875       498249       320.00
       2.413     0.997266       498442       365.71
       2.449     0.997656       498636       426.67
       2.509     0.998047       498828       512.00
       2.555     0.998242       498926       568.89
       2.651     0.998437       499024       640.00
       2.889     0.998633       499121       731.43
       3.233     0.998828       499219       853.33
       3.581     0.999023       499316      1024.00
       3.795     0.999121       499365      1137.78
       3.999     0.999219       499415      1280.00
       4.335     0.999316       499463      1462.86
       4.631     0.999414       499512      1706.67
       4.907     0.999512       499560      2048.00
       5.043     0.999561       499585      2275.56
       5.183     0.999609       499610      2560.00
       5.415     0.999658       499634      2925.71
       5.783     0.999707       499658      3413.33
       6.091     0.999756       499684      4096.00
       6.215     0.999780       499695      4551.11
       6.287     0.999805       499708      5120.00
       6.471     0.999829       499719      5851.43
       6.575     0.999854       499731      6826.67
       7.107     0.999878       499744      8192.00
       7.219     0.999890       499750      9102.22
       7.471     0.999902       499756     10240.00
       7.567     0.999915       499762     11702.86
       7.655     0.999927       499768     13653.33
       7.843     0.999939       499774     16384.00
       7.947     0.999945       499777     18204.44
       8.199     0.999951       499780     20480.00
       8.551     0.999957       499783     23405.71
       8.591     0.999963       499786     27306.67
       8.839     0.999969       499789     32768.00
       8.919     0.999973       499791     36408.89
       8.975     0.999976       499792     40960.00
       9.031     0.999979       499794     46811.43
       9.055     0.999982       499795     54613.33
       9.295     0.999985       499797     65536.00
       9.655     0.999986       499798     72817.78
       9.655     0.999988       499798     81920.00
       9.727     0.999989       499799     93622.86
       9.871     0.999991       499800    109226.67
       9.903     0.999992       499801    131072.00
       9.903     0.999993       499801    145635.56
       9.903     0.999994       499801    163840.00
       9.959     0.999995       499802    187245.71
       9.959     0.999995       499802    218453.33
      10.015     0.999996       499803    262144.00
      10.015     0.999997       499803    291271.11
      10.015     0.999997       499803    327680.00
      10.015     0.999997       499803    374491.43
      10.015     0.999998       499803    436906.67
      10.431     0.999998       499804    524288.00
      10.431     1.000000       499804          inf
#[Mean    =        1.092, StdDeviation   =        0.483]
#[Max     =       10.424, Total count    =       499804]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599924 requests in 1.00m, 41.88MB read
Requests/sec:   9998.64
Transfer/sec:    714.67KB

```
### Async-profiler
#### [Output CPU for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage2/report/stage2/get-cpu.html)
#### [Output ALLOC for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage2/report/stage2/get-alloc.html)
#### [Output LOCK for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage2/report/stage2/get-lock.html)

### Conclusions

1. Сервер выдержал нагрузку в 10к req/ses в течении 1m. Не происходит такого скачка задержки
как в stage1 и это при условии, что у нас 16 подключений к базе и 4 потока, а не одно подключение и один поток


2. При профилировании CPU мы видим, что опять one.nio заняла достаточную долю (37%), что должно нам
о чём-то говорить. Например, об оптимизации протокола или его замене на другой. 
В принципе результат очень схож со stage 1 кроме garbage collector. Он занимает
максимально неощутимую долю (меньше 1%)


3. При профилировании alloc мы видим, что ситуация максимально схожа со stage1. Но итераторы начали занимать
больше %. Это связанно с тем, что мы сделали параллельный flush и фоновый compaction.


4. При профилировании lock мы видим 0 блокировок


Так же хочется добавить, что резкое увеличение latency может быть связано со множеством факторов 
(потери сетевого пакета и повторная передача, паузы на сборку мусора, требование чтения с диска + какие-то физические явления, связанные с аппаратной частью).
