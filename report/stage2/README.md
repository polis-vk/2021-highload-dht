# 2021-highload-dht
Курсовой проект 2021 года [курса](https://polis.mail.ru/curriculum/program/discipline/1257/) "Проектирование высоконагруженных систем" в [Технополис](https://polis.mail.ru).

## Этап 2. Многопоточность (deadline 2021-10-13 23:59:59 MSK)
## Report

### Использование wrk2 для нагрузочного тестирования с заданным rate (стабильная нагрузка) 
#### Type request: [PUT](https://github.com/sdimosik/2021-highload-dht/tree/stage2/wrk/put.lua)
#### Запуск wrk2 для put-запроосов
```
wrk2 -c 16 -t 4 -d 1m -R 10k -L -s wrk/put.lua http://localhost:8080
```
#### Output
```
Running 1m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 1.029ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.063ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.086ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.076ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.07ms  595.24us  15.70ms   75.28%
    Req/Sec     2.64k   216.76     6.00k    78.76%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.00ms
 75.000%    1.42ms
 90.000%    1.75ms
 99.000%    2.14ms
 99.900%    7.87ms
 99.990%   13.02ms
 99.999%   14.77ms
100.000%   15.70ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.066     0.000000            1         1.00
       0.450     0.100000        50099         1.11
       0.592     0.200000       100203         1.25
       0.719     0.300000       150195         1.43
       0.854     0.400000       200096         1.67
       1.000     0.500000       249974         2.00
       1.077     0.550000       275003         2.22
       1.159     0.600000       300043         2.50
       1.245     0.650000       324922         2.86
       1.333     0.700000       349858         3.33
       1.422     0.750000       374959         4.00
       1.469     0.775000       387555         4.44
       1.518     0.800000       399990         5.00
       1.570     0.825000       412327         5.71
       1.627     0.850000       424922         6.67
       1.687     0.875000       437463         8.00
       1.719     0.887500       443609         8.89
       1.751     0.900000       449929        10.00
       1.785     0.912500       456089        11.43
       1.821     0.925000       462464        13.33
       1.858     0.937500       468600        16.00
       1.879     0.943750       471817        17.78
       1.901     0.950000       474875        20.00
       1.925     0.956250       477924        22.86
       1.952     0.962500       481077        26.67
       1.981     0.968750       484262        32.00
       1.996     0.971875       485740        35.56
       2.014     0.975000       487357        40.00
       2.032     0.978125       488862        45.71
       2.055     0.981250       490475        53.33
       2.081     0.984375       492053        64.00
       2.095     0.985938       492787        71.11
       2.111     0.987500       493572        80.00
       2.131     0.989062       494387        91.43
       2.151     0.990625       495103       106.67
       2.177     0.992188       495893       128.00
       2.195     0.992969       496303       142.22
       2.213     0.993750       496692       160.00
       2.235     0.994531       497064       182.86
       2.269     0.995313       497451       213.33
       2.317     0.996094       497844       256.00
       2.355     0.996484       498033       284.44
       2.455     0.996875       498225       320.00
       2.851     0.997266       498420       365.71
       3.683     0.997656       498616       426.67
       4.779     0.998047       498810       512.00
       5.331     0.998242       498908       568.89
       5.887     0.998437       499009       640.00
       6.523     0.998633       499103       731.43
       7.171     0.998828       499202       853.33
       7.955     0.999023       499298      1024.00
       8.327     0.999121       499347      1137.78
       8.679     0.999219       499396      1280.00
       9.135     0.999316       499445      1462.86
       9.575     0.999414       499494      1706.67
      10.039     0.999512       499542      2048.00
      10.391     0.999561       499567      2275.56
      10.671     0.999609       499591      2560.00
      10.935     0.999658       499616      2925.71
      11.279     0.999707       499641      3413.33
      11.671     0.999756       499664      4096.00
      11.887     0.999780       499677      4551.11
      11.991     0.999805       499689      5120.00
      12.151     0.999829       499701      5851.43
      12.487     0.999854       499713      6826.67
      12.767     0.999878       499725      8192.00
      12.991     0.999890       499732      9102.22
      13.055     0.999902       499738     10240.00
      13.175     0.999915       499744     11702.86
      13.343     0.999927       499751     13653.33
      13.471     0.999939       499757     16384.00
      13.775     0.999945       499759     18204.44
      13.807     0.999951       499762     20480.00
      13.823     0.999957       499765     23405.71
      13.983     0.999963       499768     27306.67
      14.159     0.999969       499771     32768.00
      14.207     0.999973       499773     36408.89
      14.231     0.999976       499774     40960.00
      14.463     0.999979       499776     46811.43
      14.479     0.999982       499777     54613.33
      14.567     0.999985       499779     65536.00
      14.767     0.999986       499781     72817.78
      14.767     0.999988       499781     81920.00
      14.767     0.999989       499781     93622.86
      14.831     0.999991       499782    109226.67
      14.863     0.999992       499783    131072.00
      14.863     0.999993       499783    145635.56
      14.863     0.999994       499783    163840.00
      14.991     0.999995       499784    187245.71
      14.991     0.999995       499784    218453.33
      15.015     0.999996       499785    262144.00
      15.015     0.999997       499785    291271.11
      15.015     0.999997       499785    327680.00
      15.015     0.999997       499785    374491.43
      15.015     0.999998       499785    436906.67
      15.703     0.999998       499786    524288.00
      15.703     1.000000       499786          inf
#[Mean    =        1.067, StdDeviation   =        0.595]
#[Max     =       15.696, Total count    =       499786]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599912 requests in 1.00m, 38.33MB read
Requests/sec:   9998.77
Transfer/sec:    654.22KB

```

### Async-profiler
#### [Output CPU for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/tree/stage2/repot/stage2/put-cpu.html)
#### [Output ALLOC for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/tree/stage2/repot/stage2/put-alloc.html)
#### [Output LOCK for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/tree/stage2/repot/stage2/put-lock.html)

### Conclusions

1. Сервер выдержал нагрузку в 10к req/ses в течении 1m. И что самое главное flush данных не привёл к 
большой задержке, как в stage1 (Самая большая задержка 8.792ms, когда в stage 1 была 1928ms. Так же 
хочется отметить, что 90% всех запросов в stage 1 имеют адекватную задежрку до 2.5ms)
  
 
2. При профилировании cpu мы видим, что flush у нас находится слева отдельно от основной работы 
нашей LsmDAO. Flush запускается в отдельном потоке и съедает около 3% cpu, что очевидно мало 
по сравнению со stage 1 (20.5%).


3. При профилировании alloc мы видим практическую такую же картину, как и на прошлом этапе


4. При профилировании lock мы видим блокировки от logger'a (около 70%) и 30% от upsert (2 сэмпла).
В нашей реализации всегда будут блокировки, если происходит flush и другой поток захочет сделать flush. 
Нужно дождаться flush от первого потока, а затем уже запускать flush из второго. Но если запроса 
на второй flush не будет во время выполнения первого, то первый выполняет flush полностью параллельно.
Полноценный параллельный flush возможен, если бы в наших записях был timestamp

   ### Type request: [GET](https://github.com/sdimosik/2021-highload-dht/tree/stage2/wrk/get.lua)
#### Запуск wrk2 для put-запроосов
```
wrk2 -c 16 -t 4 -d 1m -R 10k -L -s wrk/get.lua http://localhost:8080  
```
#### Output
```
Running 1m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 1.088ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.081ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.108ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.088ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.09ms  504.07us   8.79ms   65.10%
    Req/Sec     2.65k   188.66     4.22k    72.52%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.03ms
 75.000%    1.44ms
 90.000%    1.80ms
 99.000%    2.20ms
 99.900%    3.37ms
 99.990%    6.30ms
 99.999%    8.14ms
100.000%    8.80ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.064     0.000000            1         1.00
       0.478     0.100000        50050         1.11
       0.627     0.200000       100197         1.25
       0.755     0.300000       150200         1.43
       0.887     0.400000       200115         1.67
       1.033     0.500000       250199         2.00
       1.109     0.550000       275090         2.22
       1.187     0.600000       300159         2.50
       1.267     0.650000       325115         2.86
       1.350     0.700000       349969         3.33
       1.442     0.750000       374984         4.00
       1.493     0.775000       387566         4.44
       1.548     0.800000       399950         5.00
       1.606     0.825000       412504         5.71
       1.667     0.850000       424938         6.67
       1.731     0.875000       437501         8.00
       1.763     0.887500       443610         8.89
       1.796     0.900000       449862        10.00
       1.832     0.912500       456222        11.43
       1.868     0.925000       462416        13.33
       1.908     0.937500       468695        16.00
       1.929     0.943750       471781        17.78
       1.952     0.950000       474896        20.00
       1.976     0.956250       477989        22.86
       2.003     0.962500       481127        26.67
       2.033     0.968750       484188        32.00
       2.051     0.971875       485902        35.56
       2.067     0.975000       487303        40.00
       2.089     0.978125       488990        45.71
       2.111     0.981250       490425        53.33
       2.139     0.984375       492037        64.00
       2.155     0.985938       492795        71.11
       2.173     0.987500       493596        80.00
       2.193     0.989062       494387        91.43
       2.215     0.990625       495147       106.67
       2.241     0.992188       495909       128.00
       2.257     0.992969       496324       142.22
       2.275     0.993750       496697       160.00
       2.295     0.994531       497080       182.86
       2.319     0.995313       497475       213.33
       2.349     0.996094       497862       256.00
       2.371     0.996484       498050       284.44
       2.393     0.996875       498238       320.00
       2.419     0.997266       498433       365.71
       2.465     0.997656       498626       426.67
       2.547     0.998047       498821       512.00
       2.603     0.998242       498919       568.89
       2.701     0.998437       499016       640.00
       2.885     0.998633       499112       731.43
       3.125     0.998828       499210       853.33
       3.399     0.999023       499307      1024.00
       3.547     0.999121       499356      1137.78
       3.717     0.999219       499406      1280.00
       3.933     0.999316       499454      1462.86
       4.155     0.999414       499504      1706.67
       4.423     0.999512       499552      2048.00
       4.583     0.999561       499576      2275.56
       4.739     0.999609       499600      2560.00
       4.931     0.999658       499625      2925.71
       5.135     0.999707       499649      3413.33
       5.347     0.999756       499674      4096.00
       5.471     0.999780       499686      4551.11
       5.655     0.999805       499698      5120.00
       5.783     0.999829       499710      5851.43
       5.919     0.999854       499722      6826.67
       6.155     0.999878       499734      8192.00
       6.251     0.999890       499742      9102.22
       6.359     0.999902       499747     10240.00
       6.423     0.999915       499753     11702.86
       6.535     0.999927       499759     13653.33
       6.639     0.999939       499765     16384.00
       6.659     0.999945       499768     18204.44
       6.803     0.999951       499771     20480.00
       7.043     0.999957       499774     23405.71
       7.127     0.999963       499777     27306.67
       7.211     0.999969       499780     32768.00
       7.367     0.999973       499782     36408.89
       7.387     0.999976       499783     40960.00
       7.511     0.999979       499785     46811.43
       7.715     0.999982       499786     54613.33
       8.007     0.999985       499788     65536.00
       8.011     0.999986       499789     72817.78
       8.011     0.999988       499789     81920.00
       8.135     0.999989       499790     93622.86
       8.199     0.999991       499791    109226.67
       8.279     0.999992       499792    131072.00
       8.279     0.999993       499792    145635.56
       8.279     0.999994       499792    163840.00
       8.535     0.999995       499793    187245.71
       8.535     0.999995       499793    218453.33
       8.583     0.999996       499794    262144.00
       8.583     0.999997       499794    291271.11
       8.583     0.999997       499794    327680.00
       8.583     0.999997       499794    374491.43
       8.583     0.999998       499794    436906.67
       8.799     0.999998       499795    524288.00
       8.799     1.000000       499795          inf
#[Mean    =        1.090, StdDeviation   =        0.504]
#[Max     =        8.792, Total count    =       499795]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599913 requests in 1.00m, 41.88MB read
Requests/sec:   9998.63
Transfer/sec:    714.67KB

```
### Async-profiler
#### [Output CPU for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/tree/stage2/repot/stage2/get-cpu.html)
#### [Output ALLOC for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/tree/stage2/repot/stage2/get-alloc.html)
#### [Output LOCK for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/tree/stage2/repot/stage2/get-lock.html)

### Conclusions

1. Сервер выдержал нагрузку в 10к req/ses в течении 1m. Не происходит такого скачка задержки
как в stage1 и это при условии, что у нас 16 подключений к базе и 4 потока, а не одно подключение и один поток


2. При профилировании CPU мы видим, что опять one.nio заняла достаточную долю (38%), что должно нам
о чём-то говорить. Например, об оптимизации протокола или его замене на другой. 
В принципе результат очень схож со stage 1 кроме garbage collector. Он занимает
максимально неощутимую долю (меньше 1%)


3. При профилировании alloc мы видим, что ситуация максимально схожа со stage1, sstableRanges занимает
ощутимую долю >20%. Моё предположение о фильтре Блума было неверно, как Вы подметили. Здесь виноват
compaction, который не происходит в автоматическом режиме. Его добавление должно сократить эти проценты


4. При профилировании lock мы видим 0 блокировок. Идеально.


Так же хочется добавить, что резкое увеличение latency может быть связано со множеством факторов 
(потери сетевого пакета и повторная передача, паузы на сборку мусора, требование чтения с диска + какие-то физические явления, связанные с аппаратной частью).
