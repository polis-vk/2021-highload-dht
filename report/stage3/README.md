# 2021-highload-dht
Курсовой проект 2021 года [курса](https://polis.mail.ru/curriculum/program/discipline/1257/) "Проектирование высоконагруженных систем" в [Технополис](https://polis.mail.ru).

## Этап 3. Асинхронный сервер (deadline 2021-10-20 23:59:59 MSK)
## Report

### Использование wrk2 для нагрузочного тестирования с заданным rate (стабильная нагрузка) 
#### Type request: [PUT](https://github.com/sdimosik/2021-highload-dht/tree/stage2/wrk/put.lua)
#### Запуск wrk2 для put-запроосов
```
wrk2 -c 16 -t 4 -d 1m -R 30k -L -s wrk/put.lua http://localhost:8080
```
#### Output
```
Running 1m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 1.320ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.380ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.320ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.295ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.27ms    1.34ms  43.36ms   96.53%
    Req/Sec     7.91k     0.97k   22.89k    82.40%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.09ms
 75.000%    1.53ms
 90.000%    1.94ms
 99.000%    7.05ms
 99.900%   17.68ms
 99.990%   29.20ms
 99.999%   40.00ms
100.000%   43.39ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.034     0.000000            1         1.00
       0.386     0.100000       150536         1.11
       0.591     0.200000       300532         1.25
       0.781     0.300000       450047         1.43
       0.940     0.400000       600670         1.67
       1.088     0.500000       750230         2.00
       1.161     0.550000       824749         2.22
       1.237     0.600000       900005         2.50
       1.322     0.650000       974973         2.86
       1.420     0.700000      1049930         3.33
       1.529     0.750000      1124903         4.00
       1.586     0.775000      1162620         4.44
       1.646     0.800000      1199810         5.00
       1.711     0.825000      1237361         5.71
       1.780     0.850000      1274818         6.67
       1.855     0.875000      1312015         8.00
       1.897     0.887500      1331013         8.89
       1.943     0.900000      1349578        10.00
       1.999     0.912500      1368450        11.43
       2.071     0.925000      1387321        13.33
       2.165     0.937500      1405785        16.00
       2.225     0.943750      1415098        17.78
       2.299     0.950000      1424443        20.00
       2.397     0.956250      1433882        22.86
       2.529     0.962500      1443189        26.67
       2.743     0.968750      1452553        32.00
       2.919     0.971875      1457266        35.56
       3.181     0.975000      1461914        40.00
       3.587     0.978125      1466622        45.71
       4.143     0.981250      1471304        53.33
       4.859     0.984375      1475979        64.00
       5.323     0.985938      1478314        71.11
       5.871     0.987500      1480659        80.00
       6.559     0.989062      1483004        91.43
       7.399     0.990625      1485351       106.67
       8.367     0.992188      1487702       128.00
       8.911     0.992969      1488875       142.22
       9.463     0.993750      1490035       160.00
      10.103     0.994531      1491213       182.86
      10.743     0.995313      1492377       213.33
      11.367     0.996094      1493551       256.00
      11.695     0.996484      1494130       284.44
      12.047     0.996875      1494722       320.00
      12.455     0.997266      1495304       365.71
      13.055     0.997656      1495895       426.67
      13.839     0.998047      1496475       512.00
      14.415     0.998242      1496768       568.89
      15.103     0.998437      1497056       640.00
      15.967     0.998633      1497352       731.43
      16.831     0.998828      1497641       853.33
      17.807     0.999023      1497936      1024.00
      18.287     0.999121      1498085      1137.78
      18.815     0.999219      1498233      1280.00
      19.295     0.999316      1498374      1462.86
      19.759     0.999414      1498522      1706.67
      20.351     0.999512      1498667      2048.00
      20.687     0.999561      1498740      2275.56
      21.311     0.999609      1498813      2560.00
      22.047     0.999658      1498887      2925.71
      22.959     0.999707      1498959      3413.33
      24.799     0.999756      1499033      4096.00
      25.519     0.999780      1499070      4551.11
      26.351     0.999805      1499106      5120.00
      26.959     0.999829      1499142      5851.43
      27.743     0.999854      1499179      6826.67
      28.399     0.999878      1499215      8192.00
      28.863     0.999890      1499234      9102.22
      29.391     0.999902      1499252     10240.00
      30.159     0.999915      1499270     11702.86
      30.911     0.999927      1499289     13653.33
      31.679     0.999939      1499307     16384.00
      32.127     0.999945      1499316     18204.44
      32.431     0.999951      1499325     20480.00
      33.535     0.999957      1499335     23405.71
      34.943     0.999963      1499344     27306.67
      36.127     0.999969      1499353     32768.00
      36.735     0.999973      1499357     36408.89
      37.439     0.999976      1499362     40960.00
      37.951     0.999979      1499366     46811.43
      38.623     0.999982      1499371     54613.33
      39.103     0.999985      1499376     65536.00
      39.487     0.999986      1499378     72817.78
      39.679     0.999988      1499380     81920.00
      39.871     0.999989      1499382     93622.86
      40.447     0.999991      1499385    109226.67
      41.087     0.999992      1499387    131072.00
      41.311     0.999993      1499388    145635.56
      41.599     0.999994      1499389    163840.00
      41.823     0.999995      1499390    187245.71
      42.239     0.999995      1499392    218453.33
      42.495     0.999996      1499393    262144.00
      42.495     0.999997      1499393    291271.11
      42.751     0.999997      1499394    327680.00
      42.751     0.999997      1499394    374491.43
      42.879     0.999998      1499395    436906.67
      43.071     0.999998      1499396    524288.00
      43.071     0.999998      1499396    582542.22
      43.071     0.999998      1499396    655360.00
      43.071     0.999999      1499396    748982.86
      43.231     0.999999      1499397    873813.33
      43.231     0.999999      1499397   1048576.00
      43.231     0.999999      1499397   1165084.44
      43.231     0.999999      1499397   1310720.00
      43.231     0.999999      1499397   1497965.71
      43.391     0.999999      1499398   1747626.67
      43.391     1.000000      1499398          inf
#[Mean    =        1.266, StdDeviation   =        1.344]
#[Max     =       43.360, Total count    =      1499398]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1799737 requests in 1.00m, 115.00MB read
Requests/sec:  29995.54
Transfer/sec:      1.92MB
```

### Async-profiler
#### [Output CPU for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage3/report/stage3/cpu-put.html)
#### [Output ALLOC for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage3/report/stage3/alloc-put.html)
#### [Output LOCK for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage3/report/stage3/lock-put.html)

### Conclusions

1. Сервер выдержал нагрузку в 30к req/ses в течении 1m
  
 
2. При профилировании cpu мы видим, что наша бизнес-логика вынесена из selector.thread в ThreadPoolExecutor.
А обработка запросов занимает около 11% cpu


3. При профилировании alloc мы видим, что бизнес-логика и логика обработки запросов опять вынесены в разные
пулы потоков. На обработку запросов (парс, кодировка, чтение) тратится около 43% (аналогично предыдущему stage), а в остальной части находится
бизнес логика, но почему-то put начал аллоцировать память на 30% больше чем в прошлом stage. Возможно это связано
с повышенной нагрузкой


4. При профилировании lock мы видим, что появились блокировки, связанные с блокирующей очередью в executor.
Так же есть лок на отправку response


### Type request: [GET](https://github.com/sdimosik/2021-highload-dht/tree/stage2/wrk/get.lua)
#### Запуск wrk2 для put-запроосов
```
wrk2 -c 16 -t 4 -d 1m -R 30k -L -s wrk/get.lua http://localhost:8080  
```
#### Output
```
Running 1m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 2.273ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.457ms, rate sampling interval: 11ms
  Thread calibration: mean lat.: 2.995ms, rate sampling interval: 15ms
  Thread calibration: mean lat.: 2.940ms, rate sampling interval: 15ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.76ms    2.29ms  36.99ms   93.36%
    Req/Sec     7.84k     0.86k   18.78k    81.56%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.23ms
 75.000%    1.81ms
 90.000%    2.85ms
 99.000%   12.83ms
 99.900%   24.70ms
 99.990%   31.90ms
 99.999%   36.16ms
100.000%   37.02ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.043     0.000000            1         1.00
       0.456     0.100000       150048         1.11
       0.701     0.200000       300255         1.25
       0.899     0.300000       450041         1.43
       1.069     0.400000       600167         1.67
       1.234     0.500000       749951         2.00
       1.327     0.550000       825127         2.22
       1.432     0.600000       899767         2.50
       1.547     0.650000       974612         2.86
       1.674     0.700000      1050015         3.33
       1.813     0.750000      1124988         4.00
       1.889     0.775000      1162324         4.44
       1.976     0.800000      1199719         5.00
       2.085     0.825000      1237250         5.71
       2.231     0.850000      1274612         6.67
       2.453     0.875000      1312128         8.00
       2.617     0.887500      1330802         8.89
       2.849     0.900000      1349447        10.00
       3.189     0.912500      1368273        11.43
       3.643     0.925000      1386949        13.33
       4.271     0.937500      1405703        16.00
       4.663     0.943750      1415087        17.78
       5.111     0.950000      1424458        20.00
       5.607     0.956250      1433807        22.86
       6.203     0.962500      1443183        26.67
       6.947     0.968750      1452552        32.00
       7.427     0.971875      1457219        35.56
       7.987     0.975000      1461913        40.00
       8.687     0.978125      1466613        45.71
       9.503     0.981250      1471279        53.33
      10.479     0.984375      1475978        64.00
      11.047     0.985938      1478307        71.11
      11.655     0.987500      1480652        80.00
      12.335     0.989062      1482995        91.43
      13.199     0.990625      1485328       106.67
      14.263     0.992188      1487665       128.00
      14.871     0.992969      1488840       142.22
      15.559     0.993750      1490009       160.00
      16.343     0.994531      1491184       182.86
      17.231     0.995313      1492360       213.33
      18.143     0.996094      1493523       256.00
      18.671     0.996484      1494105       284.44
      19.263     0.996875      1494702       320.00
      19.903     0.997266      1495284       365.71
      20.639     0.997656      1495866       426.67
      21.519     0.998047      1496447       512.00
      22.047     0.998242      1496744       568.89
      22.607     0.998437      1497031       640.00
      23.295     0.998633      1497328       731.43
      23.919     0.998828      1497621       853.33
      24.815     0.999023      1497912      1024.00
      25.231     0.999121      1498056      1137.78
      25.647     0.999219      1498205      1280.00
      25.999     0.999316      1498357      1462.86
      26.351     0.999414      1498500      1706.67
      26.895     0.999512      1498642      2048.00
      27.391     0.999561      1498717      2275.56
      27.823     0.999609      1498788      2560.00
      28.367     0.999658      1498863      2925.71
      28.799     0.999707      1498934      3413.33
      29.487     0.999756      1499010      4096.00
      29.823     0.999780      1499047      4551.11
      30.079     0.999805      1499081      5120.00
      30.399     0.999829      1499117      5851.43
      30.767     0.999854      1499154      6826.67
      31.247     0.999878      1499190      8192.00
      31.631     0.999890      1499209      9102.22
      32.047     0.999902      1499227     10240.00
      33.087     0.999915      1499245     11702.86
      33.983     0.999927      1499265     13653.33
      34.687     0.999939      1499287     16384.00
      34.815     0.999945      1499291     18204.44
      34.943     0.999951      1499301     20480.00
      35.135     0.999957      1499310     23405.71
      35.295     0.999963      1499321     27306.67
      35.487     0.999969      1499329     32768.00
      35.551     0.999973      1499332     36408.89
      35.615     0.999976      1499338     40960.00
      35.711     0.999979      1499342     46811.43
      35.839     0.999982      1499346     54613.33
      35.967     0.999985      1499351     65536.00
      35.999     0.999986      1499353     72817.78
      36.063     0.999988      1499355     81920.00
      36.159     0.999989      1499358     93622.86
      36.287     0.999991      1499361    109226.67
      36.319     0.999992      1499362    131072.00
      36.415     0.999993      1499363    145635.56
      36.447     0.999994      1499364    163840.00
      36.479     0.999995      1499365    187245.71
      36.607     0.999995      1499367    218453.33
      36.767     0.999996      1499368    262144.00
      36.767     0.999997      1499368    291271.11
      36.863     0.999997      1499369    327680.00
      36.863     0.999997      1499369    374491.43
      36.895     0.999998      1499370    436906.67
      36.927     0.999998      1499371    524288.00
      36.927     0.999998      1499371    582542.22
      36.927     0.999998      1499371    655360.00
      36.927     0.999999      1499371    748982.86
      37.023     0.999999      1499373    873813.33
      37.023     1.000000      1499373          inf
#[Mean    =        1.757, StdDeviation   =        2.293]
#[Max     =       36.992, Total count    =      1499373]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1799714 requests in 1.00m, 126.55MB read
Requests/sec:  29996.02
Transfer/sec:      2.11MB

```
### Async-profiler
#### [Output CPU for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage3/report/stage3/cpu-get.html)
#### [Output ALLOC for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage3/report/stage3/alloc-get.html)
#### [Output LOCK for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage3/report/stage3/lock-get.html)

### Conclusions

1. Сервер выдержал нагрузку в 30к req/ses в течении 1m


2. При профилировании CPU мы видим, что ситуация аналогична put запросам (разделение логики обработки запросов и безнос логики)


3. При профилировании alloc мы видим, что ситуация аналогична put запросам (разделение логики обработки запросов и безнос логики)


4. При профилировании lock мы видим, что ситуация аналогична put запросам. Есть блокировки при работе с очередью и отправкой запросов
