# 2021-highload-dht
Курсовой проект 2021 года [курса](https://polis.mail.ru/curriculum/program/discipline/1257/) "Проектирование высоконагруженных систем" в [Технополис](https://polis.mail.ru).

## Этап 6
## Report

### Introduction
В данном этапе была реализована поддержка асинхронного клиента, который предоставляет интерфейс
в виде CompletableFuture.

* Заместо синхронизированного send, мы отправляем с помощью sendAsync
* После мы собираем нужное нам количество завершённых запросов с помощью whenCompleteAsync
* Потом через thenApply мерджим нажи выполненые запросы и получаем 1 итоговый запрос, 
который отправляется, когда завершится (whenCompleteAsync)

### Использование wrk2 для нагрузочного тестирования с заданным rate (стабильная нагрузка) 
#### Type request: [PUT](https://github.com/sdimosik/2021-highload-dht/tree/stage6/wrk/put.lua)
#### Запуск wrk2 для put-запроосов
Были запущены 3 экземпляра wrk на каждый узел (output сокращён)
```
wrk2 -c 16 -t 4 -d 1m -R 5k -L -s wrk/put.lua http://localhost:8080  
```
#### Output
```
Running 1m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 1.499ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.504ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.525ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.505ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.95ms    2.63ms  59.17ms   94.88%
    Req/Sec     1.00k   416.92     2.89k    69.75%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.45ms
 75.000%    1.92ms
 90.000%    2.63ms
 99.000%   13.35ms
 99.900%   36.10ms
 99.990%   52.10ms
 99.999%   58.49ms
100.000%   59.20ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.292     0.000000            1         1.00
       0.772     0.100000        19083         1.11
       0.978     0.200000        38065         1.25
       1.146     0.300000        57165         1.43
       1.300     0.400000        76179         1.67
       1.454     0.500000        95248         2.00
       1.534     0.550000       104668         2.22
       1.621     0.600000       114229         2.50
       1.712     0.650000       123703         2.86
       1.810     0.700000       133230         3.33
       1.922     0.750000       142744         4.00
       1.987     0.775000       147491         4.44
       2.061     0.800000       152241         5.00
       2.149     0.825000       157065         5.71
       2.255     0.850000       161762         6.67
       2.397     0.875000       166526         8.00
       2.497     0.887500       168885         8.89
       2.633     0.900000       171284        10.00
       2.823     0.912500       173649        11.43
       3.147     0.925000       176024        13.33
       3.763     0.937500       178388        16.00
       4.195     0.943750       179576        17.78
       4.695     0.950000       180774        20.00
       5.263     0.956250       181957        22.86
       5.947     0.962500       183145        26.67
       6.795     0.968750       184336        32.00
       7.295     0.971875       184928        35.56
       7.859     0.975000       185526        40.00
       8.551     0.978125       186118        45.71
       9.399     0.981250       186714        53.33
      10.367     0.984375       187307        64.00
      10.975     0.985938       187605        71.11
      11.759     0.987500       187904        80.00
      12.695     0.989062       188198        91.43
      13.775     0.990625       188497       106.67
      15.151     0.992188       188793       128.00
      15.919     0.992969       188942       142.22
      17.039     0.993750       189090       160.00
      18.271     0.994531       189239       182.86
      19.631     0.995313       189390       213.33
      20.991     0.996094       189537       256.00
      21.855     0.996484       189611       284.44
      22.879     0.996875       189685       320.00
      24.303     0.997266       189759       365.71
      25.695     0.997656       189834       426.67
      28.207     0.998047       189909       512.00
      29.519     0.998242       189945       568.89
      31.151     0.998437       189983       640.00
      32.735     0.998633       190019       731.43
      34.655     0.998828       190060       853.33
      36.383     0.999023       190094      1024.00
      37.407     0.999121       190112      1137.78
      38.367     0.999219       190132      1280.00
      39.263     0.999316       190149      1462.86
      40.479     0.999414       190168      1706.67
      41.983     0.999512       190188      2048.00
      42.655     0.999561       190196      2275.56
      43.103     0.999609       190205      2560.00
      43.999     0.999658       190214      2925.71
      45.471     0.999707       190224      3413.33
      47.711     0.999756       190233      4096.00
      48.127     0.999780       190238      4551.11
      48.863     0.999805       190243      5120.00
      49.599     0.999829       190247      5851.43
      50.111     0.999854       190252      6826.67
      51.327     0.999878       190257      8192.00
      51.871     0.999890       190259      9102.22
      52.831     0.999902       190261     10240.00
      53.215     0.999915       190263     11702.86
      53.695     0.999927       190266     13653.33
      55.359     0.999939       190268     16384.00
      55.935     0.999945       190269     18204.44
      56.319     0.999951       190270     20480.00
      57.791     0.999957       190271     23405.71
      58.047     0.999963       190273     27306.67
      58.143     0.999969       190274     32768.00
      58.143     0.999973       190274     36408.89
      58.175     0.999976       190275     40960.00
      58.175     0.999979       190275     46811.43
      58.399     0.999982       190276     54613.33
      58.495     0.999985       190277     65536.00
      58.495     0.999986       190277     72817.78
      58.495     0.999988       190277     81920.00
      58.495     0.999989       190277     93622.86
      58.719     0.999991       190278    109226.67
      58.719     0.999992       190278    131072.00
      58.719     0.999993       190278    145635.56
      58.719     0.999994       190278    163840.00
      58.719     0.999995       190278    187245.71
      59.199     0.999995       190279    218453.33
      59.199     1.000000       190279          inf
#[Mean    =        1.951, StdDeviation   =        2.632]
#[Max     =       59.168, Total count    =       190279]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  237241 requests in 1.00m, 15.16MB read
  Socket errors: connect 0, read 0, write 0, timeout 90
Requests/sec:   3953.96
Transfer/sec:    258.71KB

```


### Async-profiler
#### [Output CPU for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage6/report/stage6/put-cpu.html)
#### [Output ALLOC for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage6/report/stage6/put-alloc.html)
#### [Output LOCK for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage6/report/stage6/put-lock.html)
### Conclusions

1. Сервер не выдержал нагрузку, хоть и задержки низкие
  
 
2. При профилировании cpu мы видим, что теперь большая часть нагрузки приходится на наш
ForkJoinPool, в котором крутятся HttpClient'ы. Вначале графика можно заметить досточно большую
часть простоя (около 10%)


3. При профилировании alloc мы видим, что добивились локации от HttpClient и CompletableFuture


4. При профилировании lock мы видим, что локи присутсвуют, но это неизбежно

### Type request: [GET](https://github.com/sdimosik/2021-highload-dht/tree/stage6/wrk/get.lua)
#### Запуск wrk2 для put-запроосов
```
wrk2 -c 16 -t 4 -d 1m -R 5k -L -s wrk/get.lua http://localhost:8080  
```

#### Output
```
Running 1m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 3.380ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 4.013ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 3.434ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 3.929ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.82ms    2.46ms  32.62ms   94.74%
    Req/Sec   790.86    302.19     3.00k    77.19%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.31ms
 75.000%    1.72ms
 90.000%    2.29ms
 99.000%   15.09ms
 99.900%   25.41ms
 99.990%   30.50ms
 99.999%   32.29ms
100.000%   32.64ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.318     0.000000            2         1.00
       0.704     0.100000        15002         1.11
       0.867     0.200000        30037         1.25
       1.016     0.300000        45067         1.43
       1.161     0.400000        60022         1.67
       1.306     0.500000        74968         2.00
       1.378     0.550000        82455         2.22
       1.450     0.600000        89971         2.50
       1.525     0.650000        97486         2.86
       1.612     0.700000       104951         3.33
       1.716     0.750000       112449         4.00
       1.776     0.775000       116184         4.44
       1.842     0.800000       119953         5.00
       1.914     0.825000       123686         5.71
       2.001     0.850000       127424         6.67
       2.115     0.875000       131178         8.00
       2.189     0.887500       133052         8.89
       2.289     0.900000       134919        10.00
       2.439     0.912500       136805        11.43
       2.711     0.925000       138660        13.33
       3.355     0.937500       140536        16.00
       3.883     0.943750       141471        17.78
       4.567     0.950000       142410        20.00
       5.351     0.956250       143345        22.86
       6.375     0.962500       144283        26.67
       7.683     0.968750       145220        32.00
       8.503     0.971875       145688        35.56
       9.343     0.975000       146158        40.00
      10.303     0.978125       146625        45.71
      11.391     0.981250       147093        53.33
      12.575     0.984375       147562        64.00
      13.159     0.985938       147796        71.11
      13.855     0.987500       148029        80.00
      14.615     0.989062       148265        91.43
      15.415     0.990625       148501       106.67
      16.367     0.992188       148731       128.00
      16.879     0.992969       148849       142.22
      17.391     0.993750       148968       160.00
      18.079     0.994531       149083       182.86
      18.847     0.995313       149200       213.33
      19.631     0.996094       149317       256.00
      20.063     0.996484       149379       284.44
      20.655     0.996875       149435       320.00
      21.167     0.997266       149493       365.71
      21.887     0.997656       149551       426.67
      22.719     0.998047       149610       512.00
      23.199     0.998242       149639       568.89
      23.663     0.998437       149668       640.00
      24.255     0.998633       149699       731.43
      24.863     0.998828       149727       853.33
      25.503     0.999023       149756      1024.00
      25.759     0.999121       149772      1137.78
      26.239     0.999219       149786      1280.00
      26.623     0.999316       149800      1462.86
      27.135     0.999414       149815      1706.67
      27.503     0.999512       149829      2048.00
      27.711     0.999561       149838      2275.56
      27.919     0.999609       149844      2560.00
      28.271     0.999658       149851      2925.71
      28.687     0.999707       149859      3413.33
      29.039     0.999756       149866      4096.00
      29.119     0.999780       149870      4551.11
      29.407     0.999805       149873      5120.00
      29.695     0.999829       149877      5851.43
      30.047     0.999854       149881      6826.67
      30.351     0.999878       149884      8192.00
      30.447     0.999890       149886      9102.22
      30.543     0.999902       149888     10240.00
      30.591     0.999915       149890     11702.86
      30.863     0.999927       149892     13653.33
      30.927     0.999939       149893     16384.00
      31.023     0.999945       149894     18204.44
      31.551     0.999951       149895     20480.00
      31.615     0.999957       149896     23405.71
      31.679     0.999963       149897     27306.67
      31.727     0.999969       149898     32768.00
      31.727     0.999973       149898     36408.89
      31.871     0.999976       149899     40960.00
      31.871     0.999979       149899     46811.43
      31.935     0.999982       149900     54613.33
      31.935     0.999985       149900     65536.00
      31.935     0.999986       149900     72817.78
      32.287     0.999988       149901     81920.00
      32.287     0.999989       149901     93622.86
      32.287     0.999991       149901    109226.67
      32.287     0.999992       149901    131072.00
      32.287     0.999993       149901    145635.56
      32.639     0.999994       149902    163840.00
      32.639     1.000000       149902          inf
#[Mean    =        1.815, StdDeviation   =        2.455]
#[Max     =       32.624, Total count    =       149902]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  191845 requests in 1.00m, 22.64MB read
  Socket errors: connect 0, read 0, write 0, timeout 161
Requests/sec:   3197.34
Transfer/sec:    386.46KB

```

### Async-profiler
#### [Output CPU for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage6/report/stage6/get-cpu.html)
#### [Output ALLOC for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage6/report/stage6/get-alloc.html)
#### [Output LOCK for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage6/report/stage6/get-lock.html)

### Conclusions

1. Сервер не выдержал нагрузку, хоть и задержки низкие


2. При профилировании CPU мы видим ситуацию схожую с PUT запросами


3. При профилировании alloc видим ситуацию схожую с PUT запросами


4. При профилировании lock мы видим ситуацию схожую с PUT запросами