# 2021-highload-dht
Курсовой проект 2021 года [курса](https://polis.mail.ru/curriculum/program/discipline/1257/) "Проектирование высоконагруженных систем" в [Технополис](https://polis.mail.ru).

## Этап 5
## Report

### Introduction
В данном этапе была реализована поддержка репликации за счёт введения timestamp'ов. 
Так же был добавлен новый range, в котором нет TombstoneFilter. Так же с помощью headear'ов у
response была реализовано возможность проверять timestamp, isTombstone у возвращаемого значения в get-методе 
и возможность быстро проверить является ли запрос перенаправленным с другой ноды. 
К сожалению, perfomance деградировал (особенно это заметно в get-запросах) 

### Использование wrk2 для нагрузочного тестирования с заданным rate (стабильная нагрузка) 
#### Type request: [PUT](https://github.com/sdimosik/2021-highload-dht/tree/stage5/wrk/put.lua)
#### Запуск wrk2 для put-запроосов
Были запущены 3 экземпляра wrk на каждый узел (output сокращён)
```
wrk2 -c 16 -t 4 -d 4m -R 5k -L -s wrk/put.lua http://localhost:8080  
```
#### Output
```
Running 4m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 2.073ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.822ms, rate sampling interval: 11ms
  Thread calibration: mean lat.: 1.940ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.990ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.43ms   11.03ms 250.24ms   94.45%
    Req/Sec     1.33k   360.61     5.90k    84.47%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.79ms
 75.000%    2.82ms
 90.000%    8.06ms
 99.000%   54.72ms
 99.900%  134.78ms
 99.990%  211.33ms
 99.999%  244.10ms
100.000%  250.37ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.207     0.000000            1         1.00
       0.870     0.100000       115189         1.11
       1.119     0.200000       230259         1.25
       1.336     0.300000       345075         1.43
       1.552     0.400000       460335         1.67
       1.786     0.500000       575311         2.00
       1.920     0.550000       632565         2.22
       2.071     0.600000       690215         2.50
       2.249     0.650000       747439         2.86
       2.481     0.700000       805310         3.33
       2.817     0.750000       862390         4.00
       3.067     0.775000       891223         4.44
       3.401     0.800000       919891         5.00
       3.887     0.825000       948635         5.71
       4.643     0.850000       977413         6.67
       5.935     0.875000      1006173         8.00
       6.871     0.887500      1020507         8.89
       8.055     0.900000      1034896        10.00
       9.607     0.912500      1049266        11.43
      11.503     0.925000      1063643        13.33
      13.855     0.937500      1077999        16.00
      15.279     0.943750      1085193        17.78
      16.927     0.950000      1092354        20.00
      18.959     0.956250      1099551        22.86
      21.423     0.962500      1106732        26.67
      24.735     0.968750      1113929        32.00
      26.783     0.971875      1117516        35.56
      29.199     0.975000      1121105        40.00
      32.095     0.978125      1124706        45.71
      35.519     0.981250      1128324        53.33
      39.839     0.984375      1131903        64.00
      42.783     0.985938      1133681        71.11
      46.335     0.987500      1135485        80.00
      51.071     0.989062      1137279        91.43
      57.375     0.990625      1139070       106.67
      64.287     0.992188      1140865       128.00
      68.543     0.992969      1141762       142.22
      73.471     0.993750      1142669       160.00
      78.335     0.994531      1143561       182.86
      83.839     0.995313      1144467       213.33
      90.431     0.996094      1145357       256.00
      94.527     0.996484      1145809       284.44
      98.559     0.996875      1146258       320.00
     102.975     0.997266      1146707       365.71
     108.095     0.997656      1147153       426.67
     113.663     0.998047      1147604       512.00
     116.735     0.998242      1147828       568.89
     120.319     0.998437      1148052       640.00
     124.735     0.998633      1148274       731.43
     129.727     0.998828      1148503       853.33
     135.807     0.999023      1148726      1024.00
     139.263     0.999121      1148837      1137.78
     143.615     0.999219      1148949      1280.00
     148.351     0.999316      1149061      1462.86
     152.831     0.999414      1149174      1706.67
     157.951     0.999512      1149287      2048.00
     161.023     0.999561      1149342      2275.56
     164.991     0.999609      1149397      2560.00
     169.855     0.999658      1149456      2925.71
     174.335     0.999707      1149510      3413.33
     179.839     0.999756      1149566      4096.00
     182.911     0.999780      1149596      4551.11
     185.855     0.999805      1149624      5120.00
     193.663     0.999829      1149650      5851.43
     200.063     0.999854      1149678      6826.67
     204.927     0.999878      1149706      8192.00
     208.383     0.999890      1149720      9102.22
     211.839     0.999902      1149735     10240.00
     215.679     0.999915      1149748     11702.86
     218.111     0.999927      1149762     13653.33
     220.159     0.999939      1149776     16384.00
     221.823     0.999945      1149783     18204.44
     223.487     0.999951      1149790     20480.00
     226.047     0.999957      1149798     23405.71
     228.095     0.999963      1149804     27306.67
     230.143     0.999969      1149811     32768.00
     235.775     0.999973      1149815     36408.89
     236.671     0.999976      1149818     40960.00
     239.359     0.999979      1149822     46811.43
     240.639     0.999982      1149825     54613.33
     242.175     0.999985      1149829     65536.00
     242.559     0.999986      1149831     72817.78
     243.071     0.999988      1149832     81920.00
     243.455     0.999989      1149834     93622.86
     244.735     0.999991      1149837    109226.67
     245.503     0.999992      1149838    131072.00
     246.015     0.999993      1149839    145635.56
     246.015     0.999994      1149839    163840.00
     246.399     0.999995      1149840    187245.71
     246.911     0.999995      1149841    218453.33
     247.295     0.999996      1149842    262144.00
     248.063     0.999997      1149843    291271.11
     248.063     0.999997      1149843    327680.00
     248.063     0.999997      1149843    374491.43
     249.215     0.999998      1149844    436906.67
     249.215     0.999998      1149844    524288.00
     249.599     0.999998      1149845    582542.22
     249.599     0.999998      1149845    655360.00
     249.599     0.999999      1149845    748982.86
     249.599     0.999999      1149845    873813.33
     249.599     0.999999      1149845   1048576.00
     250.367     0.999999      1149846   1165084.44
     250.367     1.000000      1149846          inf
#[Mean    =        4.433, StdDeviation   =       11.025]
#[Max     =      250.240, Total count    =      1149846]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1199918 requests in 4.00m, 76.67MB read
Requests/sec:   4999.56
Transfer/sec:    327.12KB

```


### Async-profiler
#### [Output CPU for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage5/report/stage5/put-cpu.html)
#### [Output ALLOC for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage5/report/stage5/put-alloc.html)
#### [Output LOCK for PUT-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage5/report/stage5/put-lock.html)
### Conclusions

1. Сервер выдержал нагрузку
  
 
2. При профилировании cpu мы видим, что compaction отъедает 23%, 25% отъедает перенаправление запроса. Можно так же 
заметить, что любой sendResponse занимает приличное кол-во %


3. При профилировании alloc мы видим, что invoke всё так же аллоцирует много памяти (70%)


4. При профилировании lock ничего не изменилось по сравнению с предыдущим этапом

### Type request: [GET](https://github.com/sdimosik/2021-highload-dht/tree/stage5/wrk/get.lua)
#### Запуск wrk2 для put-запроосов
```
wrk2 -c 16 -t 4 -d 4m -R 5k -L -s wrk/get.lua http://localhost:8080
```

#### Output
```
Running 4m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 9223372036854776.000ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 9223372036854776.000ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 9223372036854776.000ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 9223372036854776.000ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    33.11s    36.42s    1.84m    77.88%
    Req/Sec     1.38k     1.88k   11.33k    85.18%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%   18.83s 
 75.000%    1.07m 
 90.000%    1.53m 
 99.000%    1.80m 
 99.900%    1.83m 
 99.990%    1.84m 
 99.999%    1.84m 
100.000%    1.84m 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.195     0.000000            1         1.00
       0.790     0.100000       120165         1.11
       1.135     0.200000       240075         1.25
       1.493     0.300000       360259         1.43
     333.311     0.400000       479985         1.67
   18825.215     0.500000       600038         2.00
   27869.183     0.550000       660006         2.22
   36962.303     0.600000       720075         2.50
   46104.575     0.650000       780089         2.86
   55214.079     0.700000       840032         3.33
   64389.119     0.750000       900125         4.00
   68943.871     0.775000       930131         4.44
   73465.855     0.800000       960322         5.00
   77987.839     0.825000       990377         5.71
   82509.823     0.850000      1020026         6.67
   87031.807     0.875000      1050256         8.00
   89260.031     0.887500      1064966         8.89
   91553.791     0.900000      1080039        10.00
   93847.551     0.912500      1094987        11.43
   96141.311     0.925000      1110073        13.33
   98435.071     0.937500      1125218        16.00
   99549.183     0.943750      1132599        17.78
  100663.295     0.950000      1140114        20.00
  101777.407     0.956250      1147693        22.86
  102891.519     0.962500      1155099        26.67
  104005.631     0.968750      1162497        32.00
  104595.455     0.971875      1166364        35.56
  105185.279     0.975000      1170211        40.00
  105775.103     0.978125      1174057        45.71
  106299.391     0.981250      1177556        53.33
  106889.215     0.984375      1181454        64.00
  107151.359     0.985938      1183169        71.11
  107479.039     0.987500      1185360        80.00
  107741.183     0.989062      1187090        91.43
  108003.327     0.990625      1188825       106.67
  108331.007     0.992188      1190983       128.00
  108462.079     0.992969      1191850       142.22
  108593.151     0.993750      1192714       160.00
  108724.223     0.994531      1193575       182.86
  108855.295     0.995313      1194427       213.33
  108986.367     0.996094      1195303       256.00
  109117.439     0.996484      1196157       284.44
  109182.975     0.996875      1196594       320.00
  109248.511     0.997266      1197037       365.71
  109314.047     0.997656      1197399       426.67
  109379.583     0.998047      1197729       512.00
  109445.119     0.998242      1198065       568.89
  109510.655     0.998437      1198330       640.00
  109510.655     0.998633      1198330       731.43
  109576.191     0.998828      1198555       853.33
  109707.263     0.999023      1198990      1024.00
  109707.263     0.999121      1198990      1137.78
  109772.799     0.999219      1199179      1280.00
  109772.799     0.999316      1199179      1462.86
  109838.335     0.999414      1199298      1706.67
  109903.871     0.999512      1199412      2048.00
  109969.407     0.999561      1199521      2275.56
  109969.407     0.999609      1199521      2560.00
  110034.943     0.999658      1199629      2925.71
  110034.943     0.999707      1199629      3413.33
  110100.479     0.999756      1199737      4096.00
  110100.479     0.999780      1199737      4551.11
  110100.479     0.999805      1199737      5120.00
  110166.015     0.999829      1199845      5851.43
  110166.015     0.999854      1199845      6826.67
  110166.015     0.999878      1199845      8192.00
  110166.015     0.999890      1199845      9102.22
  110166.015     0.999902      1199845     10240.00
  110231.551     0.999915      1199948     11702.86
  110231.551     0.999927      1199948     13653.33
  110231.551     0.999939      1199948     16384.00
  110231.551     0.999945      1199948     18204.44
  110231.551     0.999951      1199948     20480.00
  110231.551     0.999957      1199948     23405.71
  110231.551     0.999963      1199948     27306.67
  110231.551     0.999969      1199948     32768.00
  110231.551     0.999973      1199948     36408.89
  110231.551     0.999976      1199948     40960.00
  110231.551     0.999979      1199948     46811.43
  110231.551     0.999982      1199948     54613.33
  110231.551     0.999985      1199948     65536.00
  110231.551     0.999986      1199948     72817.78
  110231.551     0.999988      1199948     81920.00
  110231.551     0.999989      1199948     93622.86
  110231.551     0.999991      1199948    109226.67
  110297.087     0.999992      1199958    131072.00
  110297.087     1.000000      1199958          inf
#[Mean    =    33113.256, StdDeviation   =    36420.548]
#[Max     =   110231.552, Total count    =      1199958]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1199963 requests in 4.00m, 78.96MB read
  Socket errors: connect 0, read 1391155, write 0, timeout 0
  Non-2xx or 3xx responses: 1199963
Requests/sec:   4999.85
Transfer/sec:    336.90KB

```

### Async-profiler
#### [Output CPU for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage5/report/stage5/get-cpu.html)
#### [Output ALLOC for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage5/report/stage5/get-alloc.html)
#### [Output LOCK for GET-requests](https://htmlpreview.github.io/?https://github.com/sdimosik/2021-highload-dht/blob/stage5/report/stage5/get-lock.html)

### Conclusions

1. Сервер выдержал нагрузку, НО имеет огромные задержки


2. При профилировании CPU мы видим, что закрытие сокета отнимает 7%, когда на прошлом этапе закрытие сокета 
ничего не отнимало. HttpClient.invoke так же занимает около 20% и в остальном картина такая же как и на предыдущем этапе


3. При профилировании alloc мы видим схожу картину с предыдущим этапом


4. При профилировании lock мы видим схожу картину с предыдущим этапом, но sendResponse начал приводить к локам в 17% случаев 
(было 7%)