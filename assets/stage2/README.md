## Этап 2. Многопоточность (deadline 2021-10-06 23:59:59 MSK)

### Задание
Обеспечьте потокобезопасность реализации `DAO` с использованием примитивов `java.util.concurrent.*`.
Прокачаться можно с руководством [Java Concurrency in Practice](http://jcip.net/).

Реализуйте **асинхронный flush** MemTable в SSTable, чтобы не блокировать пользовательские запросы.

Сконфигурируйте HTTP сервер, чтобы он обрабатывал запросы с помощью пула из нескольких потоков.

Проведите нагрузочное тестирование с помощью [wrk2](https://github.com/giltene/wrk2) в **несколько соединений** (не меньше 16):
* `PUT` запросами на **стабильной** нагрузке (`wrk2` должен обеспечивать заданный с помощью `-R` rate запросов)
* `GET` запросами на **стабильной** нагрузке по **наполненной** БД

Приложите полученный консольный вывод `wrk2` для обоих видов нагрузки.

Отпрофилируйте приложение (CPU, alloc и **lock**) под `PUT` и `GET` нагрузкой с помощью [async-profiler](https://github.com/jvm-profiling-tools/async-profiler).
Приложите SVG-файлы FlameGraph `cpu`/`alloc`/`lock` для `PUT`/`GET` нагрузки.

**Объясните** результаты нагрузочного тестирования и профилирования и приложите **текстовый отчёт** (в Markdown).

### Ход работы

Запустим сервер
```
$ ./gradlew run
```
#### PUT запросы
Проведем нагрузочное тестирование с помощью wrk2 в 16 соединений PUT запросами, используя [скрипт](../scripts/put.lua):
```
counter = 0

request = function()
   path = "/v0/entity?id=key" .. counter
   wrk.method = "PUT"
   wrk.body = "value" .. counter
   counter = counter + 1
   return wrk.format(nil, path)
end
```

Для этого введем команду:
```
$ wrk2 -c16 -t4 -d5m -R10000 -s assets/scripts/put.lua -L http://localhost:8080

```

Параллельно начнем профилирование, узнав перед этим PID процесса с помощью `jps`.
```
$ jps
3906 GradleDaemon
5989 Jps
5975 Server
5960 GradleWrapperMain
1018 
1098 GradleDaemon

$ ./profiler.sh -d 30 -f put-cpu.html 5975
$ ./profiler.sh -d 30 -e alloc -f put-alloc.html 5975
$ ./profiler.sh -d 30 -e lock -f put-lock.html 5975
```

Результаты тестирования
```
Running 5m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 1.504ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.537ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.531ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.577ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.72ms    3.67ms 162.18ms   98.19%
    Req/Sec     2.64k   440.10    21.22k    87.71%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.32ms
 75.000%    1.84ms
 90.000%    2.42ms
 99.000%    8.80ms
 99.900%   56.03ms
 99.990%  132.22ms
 99.999%  153.47ms
100.000%  162.30ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.049     0.000000            1         1.00
       0.567     0.100000       290977         1.11
       0.784     0.200000       580524         1.25
       0.967     0.300000       870884         1.43
       1.142     0.400000      1160469         1.67
       1.320     0.500000      1451483         2.00
       1.412     0.550000      1595991         2.22
       1.508     0.600000      1740532         2.50
       1.610     0.650000      1885620         2.86
       1.721     0.700000      2030902         3.33
       1.844     0.750000      2175349         4.00
       1.913     0.775000      2247930         4.44
       1.988     0.800000      2320183         5.00
       2.073     0.825000      2393398         5.71
       2.169     0.850000      2466056         6.67
       2.281     0.875000      2537592         8.00
       2.349     0.887500      2574240         8.89
       2.425     0.900000      2610246        10.00
       2.515     0.912500      2646209        11.43
       2.625     0.925000      2682388        13.33
       2.771     0.937500      2718806        16.00
       2.867     0.943750      2736882        17.78
       2.987     0.950000      2754828        20.00
       3.149     0.956250      2772924        22.86
       3.381     0.962500      2791094        26.67
       3.731     0.968750      2809205        32.00
       3.971     0.971875      2818257        35.56
       4.291     0.975000      2827353        40.00
       4.707     0.978125      2836419        45.71
       5.251     0.981250      2845465        53.33
       6.043     0.984375      2854489        64.00
       6.571     0.985938      2859048        71.11
       7.215     0.987500      2863541        80.00
       8.103     0.989062      2868083        91.43
       9.375     0.990625      2872612       106.67
      11.391     0.992188      2877143       128.00
      12.887     0.992969      2879408       142.22
      14.783     0.993750      2881666       160.00
      17.311     0.994531      2883931       182.86
      20.767     0.995313      2886196       213.33
      24.735     0.996094      2888463       256.00
      26.735     0.996484      2889598       284.44
      29.215     0.996875      2890725       320.00
      32.447     0.997266      2891858       365.71
      36.991     0.997656      2892993       426.67
      42.239     0.998047      2894125       512.00
      44.863     0.998242      2894690       568.89
      48.063     0.998437      2895257       640.00
      51.103     0.998633      2895825       731.43
      53.823     0.998828      2896394       853.33
      56.351     0.999023      2896955      1024.00
      58.207     0.999121      2897241      1137.78
      60.191     0.999219      2897521      1280.00
      63.519     0.999316      2897806      1462.86
      67.647     0.999414      2898090      1706.67
      74.303     0.999512      2898371      2048.00
      77.695     0.999561      2898513      2275.56
      81.599     0.999609      2898654      2560.00
      86.079     0.999658      2898795      2925.71
      91.775     0.999707      2898938      3413.33
      99.583     0.999756      2899079      4096.00
     105.791     0.999780      2899150      4551.11
     111.359     0.999805      2899220      5120.00
     116.863     0.999829      2899291      5851.43
     122.303     0.999854      2899362      6826.67
     127.295     0.999878      2899433      8192.00
     129.983     0.999890      2899468      9102.22
     132.991     0.999902      2899504     10240.00
     136.575     0.999915      2899540     11702.86
     140.031     0.999927      2899574     13653.33
     143.103     0.999939      2899612     16384.00
     144.383     0.999945      2899630     18204.44
     145.791     0.999951      2899645     20480.00
     146.815     0.999957      2899663     23405.71
     147.967     0.999963      2899682     27306.67
     148.863     0.999969      2899698     32768.00
     150.015     0.999973      2899707     36408.89
     150.655     0.999976      2899717     40960.00
     151.295     0.999979      2899726     46811.43
     152.063     0.999982      2899736     54613.33
     152.447     0.999985      2899742     65536.00
     152.575     0.999986      2899747     72817.78
     152.959     0.999988      2899751     81920.00
     153.343     0.999989      2899756     93622.86
     153.855     0.999991      2899760    109226.67
     155.007     0.999992      2899767    131072.00
     155.007     0.999993      2899767    145635.56
     155.647     0.999994      2899771    163840.00
     155.647     0.999995      2899771    187245.71
     156.415     0.999995      2899773    218453.33
     156.927     0.999996      2899775    262144.00
     157.951     0.999997      2899778    291271.11
     157.951     0.999997      2899778    327680.00
     158.463     0.999997      2899779    374491.43
     158.591     0.999998      2899780    436906.67
     159.103     0.999998      2899781    524288.00
     159.487     0.999998      2899782    582542.22
     159.487     0.999998      2899782    655360.00
     159.871     0.999999      2899783    748982.86
     159.871     0.999999      2899783    873813.33
     160.127     0.999999      2899784   1048576.00
     160.127     0.999999      2899784   1165084.44
     160.127     0.999999      2899784   1310720.00
     161.407     0.999999      2899785   1497965.71
     161.407     0.999999      2899785   1747626.67
     161.407     1.000000      2899785   2097152.00
     161.407     1.000000      2899785   2330168.89
     161.407     1.000000      2899785   2621440.00
     162.303     1.000000      2899786   2995931.43
     162.303     1.000000      2899786          inf
#[Mean    =        1.716, StdDeviation   =        3.673]
#[Max     =      162.176, Total count    =      2899786]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2999916 requests in 5.00m, 191.68MB read
Requests/sec:   9999.72
Transfer/sec:    654.28KB
```

#### GET запросы
Теперь проведем тестирование GET запросами через [скрипт](../scripts/get.lua):
```
counter = 0

request = function()
   path = "/v0/entity?id=key" .. counter
   wrk.method = "GET"
   counter = counter + 1
   return wrk.format(nil, path)
end
```

введем команду:
```
$ wrk2 -c16 -t4 -d2m -R10000 -s assets/scripts/get.lua -L http://localhost:8080
```

Также начнем профилирование
```
$ ./profiler.sh -d 30 -f get-cpu.html 5975
$ ./profiler.sh -d 30 -e alloc -f get-alloc.html 5975
$ ./profiler.sh -d 30 -e lock -f get-lock.html 5975
```

Результаты тестирования
```
Running 2m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 989.003ms, rate sampling interval: 5488ms
  Thread calibration: mean lat.: 1752.347ms, rate sampling interval: 7987ms
  Thread calibration: mean lat.: 1567.717ms, rate sampling interval: 7954ms
  Thread calibration: mean lat.: 964.690ms, rate sampling interval: 5013ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   214.82ms  776.65ms   9.38s    92.46%
    Req/Sec     2.49k   137.10     2.87k    80.60%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.62ms
 75.000%    6.60ms
 90.000%  434.94ms
 99.000%    4.42s 
 99.900%    8.05s 
 99.990%    9.22s 
 99.999%    9.38s 
100.000%    9.39s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.133     0.000000            1         1.00
       0.675     0.100000       108962         1.11
       0.921     0.200000       218213         1.25
       1.139     0.300000       327128         1.43
       1.362     0.400000       435910         1.67
       1.619     0.500000       544541         2.00
       1.775     0.550000       599181         2.22
       1.964     0.600000       653592         2.50
       2.219     0.650000       707894         2.86
       2.673     0.700000       762289         3.33
       6.599     0.750000       816687         4.00
      20.575     0.775000       843939         4.44
      47.583     0.800000       871141         5.00
      93.567     0.825000       898359         5.71
     175.359     0.850000       925611         6.67
     265.983     0.875000       952813         8.00
     332.543     0.887500       966445         8.89
     434.943     0.900000       980038        10.00
     666.623     0.912500       993642        11.43
     997.887     0.925000      1007250        13.33
    1172.479     0.937500      1020862        16.00
    1248.255     0.943750      1027718        17.78
    1368.063     0.950000      1034476        20.00
    1545.215     0.956250      1041297        22.86
    1738.751     0.962500      1048108        26.67
    1851.391     0.968750      1054900        32.00
    1938.431     0.971875      1058301        35.56
    2027.519     0.975000      1061696        40.00
    2164.735     0.978125      1065111        45.71
    2410.495     0.981250      1068497        53.33
    2902.015     0.984375      1071898        64.00
    3381.247     0.985938      1073603        71.11
    4034.559     0.987500      1075306        80.00
    4308.991     0.989062      1077035        91.43
    4612.095     0.990625      1078712       106.67
    5050.367     0.992188      1080409       128.00
    5181.439     0.992969      1081297       142.22
    5255.167     0.993750      1082157       160.00
    5320.703     0.994531      1082963       182.86
    6004.735     0.995313      1083817       213.33
    6246.399     0.996094      1084670       256.00
    6356.991     0.996484      1085089       284.44
    6541.311     0.996875      1085520       320.00
    6713.343     0.997266      1085939       365.71
    7299.071     0.997656      1086361       426.67
    7434.239     0.998047      1086786       512.00
    7581.695     0.998242      1087001       568.89
    7725.055     0.998437      1087224       640.00
    7778.303     0.998633      1087436       731.43
    7827.455     0.998828      1087643       853.33
    8093.695     0.999023      1087849      1024.00
    8245.247     0.999121      1087954      1137.78
    8368.127     0.999219      1088062      1280.00
    8404.991     0.999316      1088168      1462.86
    8437.759     0.999414      1088291      1706.67
    8486.911     0.999512      1088384      2048.00
    8683.519     0.999561      1088435      2275.56
    8757.247     0.999609      1088486      2560.00
    8929.279     0.999658      1088539      2925.71
    8970.239     0.999707      1088601      3413.33
    9003.007     0.999756      1088659      4096.00
    9011.199     0.999780      1088676      4551.11
    9035.775     0.999805      1088704      5120.00
    9101.311     0.999829      1088726      5851.43
    9199.615     0.999854      1088753      6826.67
    9215.999     0.999878      1088795      8192.00
    9215.999     0.999890      1088795      9102.22
    9224.191     0.999902      1088810     10240.00
    9306.111     0.999915      1088818     11702.86
    9322.495     0.999927      1088837     13653.33
    9330.687     0.999939      1088845     16384.00
    9347.071     0.999945      1088856     18204.44
    9355.263     0.999951      1088868     20480.00
    9355.263     0.999957      1088868     23405.71
    9363.455     0.999963      1088876     27306.67
    9371.647     0.999969      1088893     32768.00
    9371.647     0.999973      1088893     36408.89
    9371.647     0.999976      1088893     40960.00
    9371.647     0.999979      1088893     46811.43
    9371.647     0.999982      1088893     54613.33
    9379.839     0.999985      1088908     65536.00
    9379.839     0.999986      1088908     72817.78
    9379.839     0.999988      1088908     81920.00
    9379.839     0.999989      1088908     93622.86
    9379.839     0.999991      1088908    109226.67
    9379.839     0.999992      1088908    131072.00
    9379.839     0.999993      1088908    145635.56
    9379.839     0.999994      1088908    163840.00
    9379.839     0.999995      1088908    187245.71
    9379.839     0.999995      1088908    218453.33
    9379.839     0.999996      1088908    262144.00
    9379.839     0.999997      1088908    291271.11
    9379.839     0.999997      1088908    327680.00
    9388.031     0.999997      1088911    374491.43
    9388.031     1.000000      1088911          inf
#[Mean    =      214.816, StdDeviation   =      776.649]
#[Max     =     9379.840, Total count    =      1088911]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1181801 requests in 2.00m, 82.94MB read
Requests/sec:   9848.39
Transfer/sec:    707.76KB
```

#### Результаты профилирования

| Тип запроса | cpu | alloc | lock |
| --- | --- | --- | --- |
| PUT | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/concurrency/assets/stage2/put/put-cpu.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/concurrency/assets/stage2/put/put-alloc.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/concurrency/assets/stage2/put/put-lock.html) |
| GET | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/concurrency/assets/stage2/get/get-cpu.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/concurrency/assets/stage2/get/get-alloc.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/concurrency/assets/stage2/get/get-lock.html) |

#### Выводы
+ нужная производительность не была достигнута - задание не выполнено... 
+ у PUT запросов при flush замечаем несколько write - не реализована буферизация для уменьшения системных вызовов (красного цвета **write**) 
+ также видимо lock на upsert (что очень странно и мне пока не ясно, почему synchronized здесь такой дорогой)
+ в allocation видим то же аллоцирование буферов, с которым пока решили смириться
+ у GET запросов lock'ов нет, что не удивительно, учитывая что были убраны synchronized блоки из range()
+ у GET большую часть (67%) занимает range()
+ замечена серьезная аллокация (26%) на merge() - создание PeekingIterator(), пока не ясно, как можно оптимизировать