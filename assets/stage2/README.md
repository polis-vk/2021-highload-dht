## Этап 2. Многопоточность (2 попытка)

### Задание
Обеспечьте потокобезопасность реализации `DAO` с использованием примитивов `java.util.concurrent.*`.
Прокачаться можно с руководством [Java Concurrency in Practice](http://jcip.net/).

Реализуйте **асинхронный flush** MemTable в SSTable, чтобы не блокировать пользовательские запросы.

Сконфигурируйте HTTP сервер, чтобы он обрабатывал запросы с помощью пула из нескольких потоков.

Проведите нагрузочное тестирование с помощью [wrk2](https://github.com/giltene/wrk2) в **несколько соединений** (не меньше 16):
* `PUT` запросами на **стабильной** нагрузке (`wrk2` должен обеспечивать заданный с помощью `-R` rate запросов)
* `GET` запросами на **стабильной** нагрузке по **наполненной** БД

Приложите полученный консольный вывод `wrk2` для обоих видов нагрузки.

Отпрофилируйте приложение (CPU, alloc и **lock**) под `PUT` и `GET` нагрузкой с помощью [async-profiler](https://github.com/jvm-profiling-tools/async-profiler).
Приложите SVG-файлы FlameGraph `cpu`/`alloc`/`lock` для `PUT`/`GET` нагрузки.

**Объясните** результаты нагрузочного тестирования и профилирования и приложите **текстовый отчёт** (в Markdown).

### Ход работы

Запустим сервер
```
$ ./gradlew run
```
#### PUT запросы
Проведем нагрузочное тестирование с помощью wrk2 в 16 соединений PUT запросами, используя [скрипт](../scripts/put.lua):
```
counter = 0

request = function()
   path = "/v0/entity?id=key" .. counter
   wrk.method = "PUT"
   wrk.body = "value" .. counter
   counter = counter + 1
   return wrk.format(nil, path)
end
```

Для этого введем команду:
```
$ wrk2 -c16 -t4 -R15000 -d2m -s assets/scripts/put.lua -L http://localhost:8080
```

Параллельно начнем профилирование, узнав перед этим PID процесса с помощью `jps`.
```
$ ./profiler.sh -d 30 -f put-cpu.html 39412
$ ./profiler.sh -d 30 -e alloc -f put-alloc.html 39412
$ ./profiler.sh -d 30 -e lock -f put-lock.html 39412
```

Результаты тестирования
```
Running 2m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 5.675ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 5.312ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 6.217ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 5.881ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.36ms   12.42ms 180.35ms   96.93%
    Req/Sec     3.97k     1.24k   33.22k    93.85%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.33ms
 75.000%    1.85ms
 90.000%    2.48ms
 99.000%   76.74ms
 99.900%  148.22ms
 99.990%  156.80ms
 99.999%  173.05ms
100.000%  180.48ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.050     0.000000            1         1.00
       0.514     0.100000       165271         1.11
       0.768     0.200000       329978         1.25
       0.973     0.300000       495129         1.43
       1.156     0.400000       660763         1.67
       1.333     0.500000       825789         2.00
       1.423     0.550000       908120         2.22
       1.517     0.600000       990307         2.50
       1.618     0.650000      1072412         2.86
       1.729     0.700000      1154938         3.33
       1.853     0.750000      1237322         4.00
       1.923     0.775000      1279003         4.44
       1.999     0.800000      1319906         5.00
       2.085     0.825000      1361079         5.71
       2.187     0.850000      1402874         6.67
       2.309     0.875000      1443548         8.00
       2.385     0.887500      1464222         8.89
       2.477     0.900000      1485092        10.00
       2.593     0.912500      1505597        11.43
       2.749     0.925000      1525995        13.33
       3.001     0.937500      1546644        16.00
       3.215     0.943750      1556896        17.78
       3.617     0.950000      1567230        20.00
       4.655     0.956250      1577517        22.86
       7.635     0.962500      1587823        26.67
      14.895     0.968750      1598128        32.00
      21.407     0.971875      1603289        35.56
      28.495     0.975000      1608444        40.00
      37.535     0.978125      1613596        45.71
      47.135     0.981250      1618748        53.33
      57.567     0.984375      1623899        64.00
      62.879     0.985938      1626477        71.11
      68.223     0.987500      1629080        80.00
      73.535     0.989062      1631633        91.43
      78.847     0.990625      1634212       106.67
      84.095     0.992188      1636789       128.00
      86.783     0.992969      1638095       142.22
      89.471     0.993750      1639372       160.00
      92.607     0.994531      1640654       182.86
      97.215     0.995313      1641949       213.33
     104.255     0.996094      1643231       256.00
     108.543     0.996484      1643879       284.44
     113.215     0.996875      1644531       320.00
     118.527     0.997266      1645169       365.71
     125.055     0.997656      1645812       426.67
     131.839     0.998047      1646461       512.00
     135.295     0.998242      1646780       568.89
     138.751     0.998437      1647106       640.00
     142.079     0.998633      1647432       731.43
     145.919     0.998828      1647752       853.33
     148.479     0.999023      1648071      1024.00
     149.631     0.999121      1648231      1137.78
     150.783     0.999219      1648394      1280.00
     151.551     0.999316      1648563      1462.86
     152.191     0.999414      1648710      1706.67
     152.959     0.999512      1648870      2048.00
     153.343     0.999561      1648961      2275.56
     153.727     0.999609      1649036      2560.00
     154.239     0.999658      1649133      2925.71
     154.623     0.999707      1649202      3413.33
     155.135     0.999756      1649287      4096.00
     155.263     0.999780      1649313      4551.11
     155.519     0.999805      1649358      5120.00
     155.775     0.999829      1649395      5851.43
     156.159     0.999854      1649445      6826.67
     156.415     0.999878      1649478      8192.00
     156.543     0.999890      1649496      9102.22
     156.799     0.999902      1649516     10240.00
     157.055     0.999915      1649542     11702.86
     157.311     0.999927      1649558     13653.33
     157.695     0.999939      1649576     16384.00
     157.951     0.999945      1649591     18204.44
     158.079     0.999951      1649598     20480.00
     158.591     0.999957      1649610     23405.71
     158.847     0.999963      1649615     27306.67
     159.487     0.999969      1649627     32768.00
     159.871     0.999973      1649631     36408.89
     160.639     0.999976      1649635     40960.00
     162.431     0.999979      1649640     46811.43
     163.967     0.999982      1649645     54613.33
     167.295     0.999985      1649650     65536.00
     169.599     0.999986      1649653     72817.78
     170.623     0.999988      1649655     81920.00
     172.159     0.999989      1649658     93622.86
     173.823     0.999991      1649660    109226.67
     175.231     0.999992      1649664    131072.00
     175.231     0.999993      1649664    145635.56
     175.487     0.999994      1649665    163840.00
     175.999     0.999995      1649668    187245.71
     175.999     0.999995      1649668    218453.33
     176.255     0.999996      1649669    262144.00
     177.023     0.999997      1649670    291271.11
     177.023     0.999997      1649670    327680.00
     177.791     0.999997      1649671    374491.43
     178.687     0.999998      1649672    436906.67
     178.687     0.999998      1649672    524288.00
     179.199     0.999998      1649673    582542.22
     179.199     0.999998      1649673    655360.00
     179.199     0.999999      1649673    748982.86
     179.711     0.999999      1649674    873813.33
     179.711     0.999999      1649674   1048576.00
     179.711     0.999999      1649674   1165084.44
     179.711     0.999999      1649674   1310720.00
     179.711     0.999999      1649674   1497965.71
     180.479     0.999999      1649675   1747626.67
     180.479     1.000000      1649675          inf
#[Mean    =        3.358, StdDeviation   =       12.417]
#[Max     =      180.352, Total count    =      1649675]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1799856 requests in 2.00m, 115.00MB read
Requests/sec:  14998.86
Transfer/sec:      0.96MB
```

#### GET запросы
Теперь проведем тестирование GET запросами через [скрипт](../scripts/get.lua):
```
counter = 0

request = function()
   path = "/v0/entity?id=key" .. counter
   wrk.method = "GET"
   counter = counter + 1
   return wrk.format(nil, path)
end
```

введем команду:
```
$ wrk2 -c16 -t4 -d2m -R10000 -s assets/scripts/get.lua -L http://localhost:8080
```

Также начнем профилирование
```
$ ./profiler.sh -d 30 -f get-cpu.html 39412
$ ./profiler.sh -d 30 -e alloc -f get-alloc.html 39412
$ ./profiler.sh -d 30 -e lock -f get-lock.html 39412
```

Результаты тестирования
```
Running 2m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 873.699ms, rate sampling interval: 4016ms
  Thread calibration: mean lat.: 979.262ms, rate sampling interval: 6504ms
  Thread calibration: mean lat.: 1062.454ms, rate sampling interval: 6668ms
  Thread calibration: mean lat.: 520.625ms, rate sampling interval: 2752ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   222.56ms  889.61ms  10.15s    93.84%
    Req/Sec     2.49k   218.35     3.24k    84.69%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.60ms
 75.000%    2.87ms
 90.000%  367.87ms
 99.000%    4.51s 
 99.900%    9.22s 
 99.990%    9.97s 
 99.999%   10.15s 
100.000%   10.16s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.148     0.000000            1         1.00
       0.700     0.100000       109476         1.11
       0.929     0.200000       219372         1.25
       1.138     0.300000       328814         1.43
       1.359     0.400000       438274         1.67
       1.602     0.500000       547603         2.00
       1.743     0.550000       602197         2.22
       1.908     0.600000       656968         2.50
       2.109     0.650000       711898         2.86
       2.383     0.700000       766201         3.33
       2.871     0.750000       820980         4.00
       3.415     0.775000       848283         4.44
       5.631     0.800000       875666         5.00
      19.519     0.825000       903018         5.71
      75.007     0.850000       930383         6.67
     172.287     0.875000       957754         8.00
     251.007     0.887500       971422         8.89
     367.871     0.900000       985101        10.00
     547.839     0.912500       998799        11.43
     793.599     0.925000      1012482        13.33
    1089.535     0.937500      1026170        16.00
    1277.951     0.943750      1033006        17.78
    1400.831     0.950000      1039891        20.00
    1524.735     0.956250      1046699        22.86
    1639.423     0.962500      1053598        26.67
    1776.639     0.968750      1060370        32.00
    2160.639     0.971875      1063774        35.56
    3090.431     0.975000      1067196        40.00
    3448.831     0.978125      1070624        45.71
    3727.359     0.981250      1074042        53.33
    3944.447     0.984375      1077471        64.00
    4079.615     0.985938      1079171        71.11
    4202.495     0.987500      1080890        80.00
    4358.143     0.989062      1082621        91.43
    4612.095     0.990625      1084295       106.67
    4837.375     0.992188      1086032       128.00
    5079.039     0.992969      1086865       142.22
    5283.839     0.993750      1087718       160.00
    6201.343     0.994531      1088571       182.86
    7192.575     0.995313      1089428       213.33
    7884.799     0.996094      1090283       256.00
    8134.655     0.996484      1090716       284.44
    8302.591     0.996875      1091137       320.00
    8495.103     0.997266      1091573       365.71
    8716.287     0.997656      1092007       426.67
    8847.359     0.998047      1092420       512.00
    8912.895     0.998242      1092661       568.89
    8970.239     0.998437      1092870       640.00
    9052.159     0.998633      1093069       731.43
    9134.079     0.998828      1093278       853.33
    9240.575     0.999023      1093490      1024.00
    9355.263     0.999121      1093603      1137.78
    9420.799     0.999219      1093709      1280.00
    9486.335     0.999316      1093816      1462.86
    9543.679     0.999414      1093921      1706.67
    9601.023     0.999512      1094038      2048.00
    9625.599     0.999561      1094089      2275.56
    9650.175     0.999609      1094138      2560.00
    9682.943     0.999658      1094195      2925.71
    9715.711     0.999707      1094245      3413.33
    9797.631     0.999756      1094290      4096.00
    9830.399     0.999780      1094319      4551.11
    9854.975     0.999805      1094343      5120.00
    9895.935     0.999829      1094373      5851.43
    9920.511     0.999854      1094396      6826.67
    9953.279     0.999878      1094430      8192.00
    9961.471     0.999890      1094439      9102.22
    9977.855     0.999902      1094456     10240.00
    9986.047     0.999915      1094467     11702.86
   10035.199     0.999927      1094478     13653.33
   10067.967     0.999939      1094490     16384.00
   10084.351     0.999945      1094497     18204.44
   10092.543     0.999951      1094503     20480.00
   10108.927     0.999957      1094513     23405.71
   10117.119     0.999963      1094517     27306.67
   10125.311     0.999969      1094526     32768.00
   10125.311     0.999973      1094526     36408.89
   10133.503     0.999976      1094535     40960.00
   10133.503     0.999979      1094535     46811.43
   10141.695     0.999982      1094544     54613.33
   10141.695     0.999985      1094544     65536.00
   10141.695     0.999986      1094544     72817.78
   10141.695     0.999988      1094544     81920.00
   10149.887     0.999989      1094549     93622.86
   10149.887     0.999991      1094549    109226.67
   10149.887     0.999992      1094549    131072.00
   10149.887     0.999993      1094549    145635.56
   10158.079     0.999994      1094556    163840.00
   10158.079     1.000000      1094556          inf
#[Mean    =      222.562, StdDeviation   =      889.611]
#[Max     =    10149.888, Total count    =      1094556]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1187048 requests in 2.00m, 83.31MB read
Requests/sec:   9892.26
Transfer/sec:    710.93KB
```

#### Результаты профилирования

| Тип запроса | cpu | alloc | lock |
| --- | --- | --- | --- |
| PUT | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/concurrency/assets/stage2/put/put-cpu.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/concurrency/assets/stage2/put/put-alloc.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/concurrency/assets/stage2/put/put-lock.html) |
| GET | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/concurrency/assets/stage2/get/get-cpu.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/concurrency/assets/stage2/get/get-alloc.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/concurrency/assets/stage2/get/get-lock.html) |

#### Выводы
+ нужная производительность не была достигнута - задание не выполнено
+ у PUT запросов при flush замечаем несколько write - не реализована буферизация для уменьшения системных вызовов (красного цвета **write**) 
+ видим lock на upsert
+ в allocation видим то же аллоцирование буферов, с которым пока решили смириться
+ у GET запросов lock'ов нет, что не удивительно, учитывая что были убраны synchronized блоки из range()
+ у GET большую часть (61%) занимает SSTable.offset()
+ замечена серьезная аллокация (26%) на merge() - создание PeekingIterator(), пока не ясно, как можно оптимизировать