## Этап 3. Асинхронный сервер (deadline 2021-10-20 23:59:59 MSK)

### Задание
Вынесите **обработку** запросов в отдельный `ExecutorService` с ограниченной очередью, чтобы разгрузить `SelectorThread`ы HTTP сервера.

Проведите нагрузочное тестирование с помощью [wrk2](https://github.com/giltene/wrk2) с **большим количеством соединений** (не меньше 64) `PUT` и `GET` запросами.

Отпрофилируйте приложение (CPU, alloc и lock) под `PUT` и `GET` нагрузкой с помощью [async-profiler](https://github.com/jvm-profiling-tools/async-profiler).

### Ход работы

Запустим сервер
```
$ ./gradlew run
```
#### PUT запросы
Проведем нагрузочное тестирование с помощью wrk2 в 16 соединений PUT запросами, используя [скрипт](../scripts/put.lua):
```
counter = 0

request = function()
   path = "/v0/entity?id=key" .. counter
   wrk.method = "PUT"
   wrk.body = "value" .. counter
   counter = counter + 1
   return wrk.format(nil, path)
end
```

Для этого введем команду:
```
$ wrk2 -c64 -t4 -R15000 -d2m -s assets/scripts/put.lua -L http://localhost:8080
```

Параллельно начнем профилирование, узнав перед этим PID процесса с помощью `jps`.
```
$ ./profiler.sh -d 30 -f put-cpu.html 80420
$ ./profiler.sh -d 30 -e alloc -f put-alloc.html 80420
$ ./profiler.sh -d 30 -e lock -f put-lock.html 80420
```

Результаты с синхронным сервером
```
Running 2m test @ http://localhost:8080
  4 threads and 16 connections
 50.000%    1.33ms
 75.000%    1.85ms
 90.000%    2.48ms
 99.000%   76.74ms
 99.900%  148.22ms
 99.990%  156.80ms
 99.999%  173.05ms
100.000%  180.48ms
```

Результаты с асинхронным серверов
```
Running 2m test @ http://localhost:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 3.792ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 3.956ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 4.117ms, rate sampling interval: 11ms
  Thread calibration: mean lat.: 3.762ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.32ms    6.42ms 137.34ms   96.99%
    Req/Sec     3.97k   749.55    20.00k    90.97%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.36ms
 75.000%    1.90ms
 90.000%    2.58ms
 99.000%   31.04ms
 99.900%   90.69ms
 99.990%  114.82ms
 99.999%  130.62ms
100.000%  137.47ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.058     0.000000            1         1.00
       0.516     0.100000       165103         1.11
       0.775     0.200000       330679         1.25
       0.985     0.300000       495151         1.43
       1.173     0.400000       660040         1.67
       1.359     0.500000       825409         2.00
       1.454     0.550000       908061         2.22
       1.552     0.600000       990171         2.50
       1.657     0.650000      1073110         2.86
       1.772     0.700000      1155533         3.33
       1.901     0.750000      1237870         4.00
       1.973     0.775000      1279144         4.44
       2.053     0.800000      1320306         5.00
       2.145     0.825000      1361526         5.71
       2.255     0.850000      1403175         6.67
       2.391     0.875000      1444199         8.00
       2.475     0.887500      1464774         8.89
       2.577     0.900000      1485072        10.00
       2.711     0.912500      1505673        11.43
       2.899     0.925000      1526349        13.33
       3.205     0.937500      1546965        16.00
       3.455     0.943750      1557197        17.78
       3.865     0.950000      1567512        20.00
       4.583     0.956250      1577798        22.86
       5.935     0.962500      1588122        26.67
       8.223     0.968750      1598446        32.00
       9.791     0.971875      1603592        35.56
      11.831     0.975000      1608747        40.00
      14.087     0.978125      1613903        45.71
      16.943     0.981250      1619072        53.33
      20.623     0.984375      1624212        64.00
      23.055     0.985938      1626784        71.11
      25.999     0.987500      1629371        80.00
      29.007     0.989062      1631948        91.43
      32.463     0.990625      1634518       106.67
      36.735     0.992188      1637100       128.00
      39.615     0.992969      1638389       142.22
      42.815     0.993750      1639676       160.00
      46.975     0.994531      1640964       182.86
      52.127     0.995313      1642251       213.33
      57.855     0.996094      1643538       256.00
      61.247     0.996484      1644183       284.44
      65.183     0.996875      1644828       320.00
      69.695     0.997266      1645475       365.71
      74.047     0.997656      1646122       426.67
      78.783     0.998047      1646762       512.00
      81.279     0.998242      1647088       568.89
      83.711     0.998437      1647406       640.00
      85.951     0.998633      1647731       731.43
      88.319     0.998828      1648055       853.33
      91.007     0.999023      1648374      1024.00
      92.671     0.999121      1648534      1137.78
      94.335     0.999219      1648695      1280.00
      95.743     0.999316      1648865      1462.86
      97.279     0.999414      1649017      1706.67
      99.327     0.999512      1649186      2048.00
     100.223     0.999561      1649258      2275.56
     101.375     0.999609      1649343      2560.00
     102.783     0.999658      1649424      2925.71
     105.087     0.999707      1649500      3413.33
     106.623     0.999756      1649582      4096.00
     107.391     0.999780      1649623      4551.11
     108.223     0.999805      1649662      5120.00
     109.439     0.999829      1649702      5851.43
     111.103     0.999854      1649742      6826.67
     113.279     0.999878      1649783      8192.00
     114.239     0.999890      1649803      9102.22
     115.135     0.999902      1649826     10240.00
     115.775     0.999915      1649843     11702.86
     116.479     0.999927      1649865     13653.33
     117.631     0.999939      1649883     16384.00
     118.527     0.999945      1649894     18204.44
     120.511     0.999951      1649903     20480.00
     122.047     0.999957      1649913     23405.71
     124.095     0.999963      1649923     27306.67
     124.991     0.999969      1649933     32768.00
     125.247     0.999973      1649938     36408.89
     125.887     0.999976      1649943     40960.00
     126.719     0.999979      1649948     46811.43
     127.743     0.999982      1649953     54613.33
     128.831     0.999985      1649958     65536.00
     129.471     0.999986      1649961     72817.78
     129.727     0.999988      1649963     81920.00
     130.495     0.999989      1649966     93622.86
     130.751     0.999991      1649968    109226.67
     131.327     0.999992      1649971    131072.00
     131.455     0.999993      1649972    145635.56
     131.583     0.999994      1649975    163840.00
     131.583     0.999995      1649975    187245.71
     131.839     0.999995      1649976    218453.33
     132.479     0.999996      1649977    262144.00
     133.247     0.999997      1649978    291271.11
     133.247     0.999997      1649978    327680.00
     134.143     0.999997      1649979    374491.43
     134.911     0.999998      1649980    436906.67
     134.911     0.999998      1649980    524288.00
     135.807     0.999998      1649981    582542.22
     135.807     0.999998      1649981    655360.00
     135.807     0.999999      1649981    748982.86
     136.575     0.999999      1649982    873813.33
     136.575     0.999999      1649982   1048576.00
     136.575     0.999999      1649982   1165084.44
     136.575     0.999999      1649982   1310720.00
     136.575     0.999999      1649982   1497965.71
     137.471     0.999999      1649983   1747626.67
     137.471     1.000000      1649983          inf
#[Mean    =        2.322, StdDeviation   =        6.415]
#[Max     =      137.344, Total count    =      1649983]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1799843 requests in 2.00m, 115.00MB read
Requests/sec:  14998.97
Transfer/sec:      0.96MB
```

#### GET запросы
Теперь проведем тестирование GET запросами через [скрипт](../scripts/get.lua):
```
counter = 0

request = function()
   path = "/v0/entity?id=key" .. counter
   wrk.method = "GET"
   counter = counter + 1
   return wrk.format(nil, path)
end
```

введем команду:
```
$ wrk2 -c64 -t4 -d2m -R10000 -s assets/scripts/get.lua -L http://localhost:8080
```

Также начнем профилирование
```
$ ./profiler.sh -d 30 -f get-cpu.html 81058
$ ./profiler.sh -d 30 -e alloc -f get-alloc.html 81058
$ ./profiler.sh -d 30 -e lock -f get-lock.html 81058
```
Результаты с синхронным сервером
```
Running 2m test @ http://localhost:8080
  4 threads and 16 connections
 50.000%    1.60ms
 75.000%    2.87ms
 90.000%  367.87ms
 99.000%    4.51s 
 99.900%    9.22s 
 99.990%    9.97s 
 99.999%   10.15s 
100.000%   10.16s 
```

Результаты с асинхронным серверов
```
Running 2m test @ http://localhost:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 103.863ms, rate sampling interval: 808ms
  Thread calibration: mean lat.: 103.568ms, rate sampling interval: 808ms
  Thread calibration: mean lat.: 104.121ms, rate sampling interval: 811ms
  Thread calibration: mean lat.: 104.441ms, rate sampling interval: 823ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.79ms    1.88ms  81.41ms   97.59%
    Req/Sec     2.50k     3.47     2.53k    88.70%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.55ms
 75.000%    2.14ms
 90.000%    2.73ms
 99.000%    6.03ms
 99.900%   26.45ms
 99.990%   48.32ms
 99.999%   67.78ms
100.000%   81.47ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.137     0.000000            1         1.00
       0.759     0.100000       109973         1.11
       0.985     0.200000       220276         1.25
       1.176     0.300000       329948         1.43
       1.360     0.400000       439696         1.67
       1.550     0.500000       549623         2.00
       1.653     0.550000       605013         2.22
       1.761     0.600000       659948         2.50
       1.876     0.650000       714742         2.86
       2.001     0.700000       769570         3.33
       2.139     0.750000       824559         4.00
       2.215     0.775000       852373         4.44
       2.295     0.800000       879775         5.00
       2.383     0.825000       907378         5.71
       2.481     0.850000       934578         6.67
       2.597     0.875000       962137         8.00
       2.663     0.887500       975794         8.89
       2.735     0.900000       989315        10.00
       2.819     0.912500      1003044        11.43
       2.919     0.925000      1016956        13.33
       3.033     0.937500      1030653        16.00
       3.097     0.943750      1037437        17.78
       3.171     0.950000      1044381        20.00
       3.255     0.956250      1051220        22.86
       3.351     0.962500      1057985        26.67
       3.477     0.968750      1064929        32.00
       3.551     0.971875      1068291        35.56
       3.645     0.975000      1071701        40.00
       3.767     0.978125      1075162        45.71
       3.939     0.981250      1078578        53.33
       4.211     0.984375      1082021        64.00
       4.423     0.985938      1083727        71.11
       4.783     0.987500      1085445        80.00
       5.427     0.989062      1087156        91.43
       6.555     0.990625      1088874       106.67
       8.415     0.992188      1090597       128.00
       9.655     0.992969      1091455       142.22
      10.831     0.993750      1092310       160.00
      11.991     0.994531      1093174       182.86
      13.327     0.995313      1094026       213.33
      15.207     0.996094      1094887       256.00
      16.447     0.996484      1095319       284.44
      17.903     0.996875      1095744       320.00
      19.295     0.997266      1096176       365.71
      20.655     0.997656      1096604       426.67
      21.951     0.998047      1097037       512.00
      22.591     0.998242      1097248       568.89
      23.279     0.998437      1097462       640.00
      24.095     0.998633      1097679       731.43
      25.023     0.998828      1097890       853.33
      26.623     0.999023      1098106      1024.00
      27.679     0.999121      1098212      1137.78
      30.031     0.999219      1098320      1280.00
      32.799     0.999316      1098428      1462.86
      36.383     0.999414      1098534      1706.67
      40.383     0.999512      1098644      2048.00
      41.535     0.999561      1098698      2275.56
      42.239     0.999609      1098750      2560.00
      42.975     0.999658      1098803      2925.71
      43.871     0.999707      1098856      3413.33
      44.799     0.999756      1098910      4096.00
      45.247     0.999780      1098938      4551.11
      45.855     0.999805      1098964      5120.00
      46.527     0.999829      1098991      5851.43
      47.039     0.999854      1099019      6826.67
      47.519     0.999878      1099044      8192.00
      47.999     0.999890      1099058      9102.22
      48.415     0.999902      1099071     10240.00
      49.215     0.999915      1099086     11702.86
      50.559     0.999927      1099098     13653.33
      51.743     0.999939      1099112     16384.00
      52.287     0.999945      1099118     18204.44
      53.407     0.999951      1099125     20480.00
      53.823     0.999957      1099132     23405.71
      54.463     0.999963      1099138     27306.67
      55.679     0.999969      1099145     32768.00
      55.967     0.999973      1099148     36408.89
      56.799     0.999976      1099152     40960.00
      57.567     0.999979      1099155     46811.43
      58.623     0.999982      1099158     54613.33
      62.175     0.999985      1099162     65536.00
      62.879     0.999986      1099163     72817.78
      64.735     0.999988      1099165     81920.00
      67.775     0.999989      1099168     93622.86
      67.775     0.999991      1099168    109226.67
      70.847     0.999992      1099170    131072.00
      72.191     0.999993      1099171    145635.56
      73.215     0.999994      1099172    163840.00
      73.599     0.999995      1099173    187245.71
      73.599     0.999995      1099173    218453.33
      76.735     0.999996      1099174    262144.00
      77.119     0.999997      1099175    291271.11
      77.119     0.999997      1099175    327680.00
      77.311     0.999997      1099176    374491.43
      77.311     0.999998      1099176    436906.67
      77.311     0.999998      1099176    524288.00
      77.567     0.999998      1099177    582542.22
      77.567     0.999998      1099177    655360.00
      77.567     0.999999      1099177    748982.86
      77.567     0.999999      1099177    873813.33
      77.567     0.999999      1099177   1048576.00
      81.471     0.999999      1099178   1165084.44
      81.471     1.000000      1099178          inf
#[Mean    =        1.795, StdDeviation   =        1.879]
#[Max     =       81.408, Total count    =      1099178]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1199621 requests in 2.00m, 82.77MB read
  Non-2xx or 3xx responses: 300146
Requests/sec:   9997.04
Transfer/sec:    706.29KB
```
#### Сравнение синхронного и асинхронного сервера
##### PUT
| HdrHistogram | Sync(16 con) | Async (64 con)| Perf |
| --- | --- | --- | --- |
|50.000%|1.33ms|1.36ms|−2%|
|75.000%|1.85ms|1.90ms|−2.7%|
|90.000%|2.48ms|2.58ms|-4%|
|99.000%|76.74ms|31.04ms|+59.5%|
|99.900%|148.22ms|90.69ms|+38.8%|
|99.990%|156.80ms|114.82ms|+26.8%|
|99.999%|173.05ms|130.62ms|+24.5%|
|100.000%|180.48ms|137.47ms|+23.8%|

##### GET  
| HdrHistogram | Sync(16 con) | Async (64 con) | Perf |
| --- | --- | --- | --- |
|50.000%|1.60ms|1.55ms|+3.13%|
|75.000%|2.87ms|2.14ms|+25.44%|
|90.000%|367.87ms|2.73ms|+99.26%|
|99.000%|4.51s|6.03ms|+99.87%|
|99.900%|9.22s|26.45ms|+99.71%|
|99.990%|9.97s|48.32ms|+99.52%|
|99.999%|10.15s|67.78ms|+99.33%|
|100.000%|10.16s|81.47ms|+99.2%|

#### Результаты профилирования

| Тип запроса | cpu | alloc | lock |
| --- | --- | --- | --- |
| PUT | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/async-server/assets/stage3/put/put-cpu.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/async-server/assets/stage3/put/put-alloc.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/async-server/assets/stage3/put/put-lock.html) |
| GET | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/async-server/assets/stage3/get/get-cpu.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/async-server/assets/stage3/get/get-alloc.html) | [ссылка](https://htmlpreview.github.io/?https://github.com/timatifey/2021-highload-dht/blob/async-server/assets/stage3/get/get-lock.html) |

#### Выводы
+ данные изменения пошли на пользу, поскольку видим явные улучшения по времени работы сервиса
+ замечаем появление lock на блокирующей очереди (8503 sample за 2 минуты), он возможен только на synchronized проверке очереди на возможность отправления новой задачи на выполнение
+ большая доля аллокаций происходит на handleRequest(43.47%), так как там идет "overhead" аллокация ByteBuffer
+ по анализу CPU на GET запросах замечаем что больше половины (**56.02% !!!**) приходится на SSTable.offset(), хоть оно и не относится к асинхронности сервера, но не обратить внимание на это нельзя 