# Задание

Проведите нагрузочное тестирование с помощью [wrk](https://github.com/giltene/wrk2) в **одно соединение**:
* `PUT` запросами на **стабильной** нагрузке (`wrk` должен обеспечивать заданный с помощью `-R` rate запросов)
* `GET` запросами на **стабильной** нагрузке по **наполненной** БД

Приложите полученный консольный вывод `wrk` для обоих видов нагрузки.

Отпрофилируйте приложение (CPU и alloc) под `PUT` и `GET` нагрузкой с помощью [async-profiler](https://github.com/jvm-profiling-tools/async-profiler).
Приложите SVG-файлы FlameGraph `cpu`/`alloc` для `PUT`/`GET` нагрузки.

**Объясните** результаты нагрузочного тестирования и профилирования и приложите **текстовый отчёт** (в Markdown).

# Отчет

Проведено нагрузочное тестирование с помощью wrk2 в одно соединение:

### PUT запросами на стабильной нагрузке (wrk должен обеспечивать заданный с помощью -R rate запросов)

Был использован скрипт `put.lua`:
```lua
counter = 0
request = function()
   path = "/v0/entity?id=key" .. counter
   wrk.method = "PUT"
   wrk.body = "value" .. counter
   counter = counter + 1
   return wrk.format(nil, path)
end
```

Нагрузочное тестирование запускалось следующей командой:
```
wrk2 -R5000  -c1 -t1 -d5m -s stage1/scripts/put.lua -L http://localhost:8080 > stage1/report/put-wrk-output
```

Консольный вывод wrk2:
```
Running 5m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.234ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   209.68ms  547.93ms   2.87s    88.30%
    Req/Sec     5.39k     3.12k   25.78k    84.48%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.34ms
 75.000%    2.33ms
 90.000%  945.15ms
 99.000%    2.45s 
 99.900%    2.79s 
 99.990%    2.85s 
 99.999%    2.88s 
100.000%    2.88s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.041     0.000000            3         1.00
       0.394     0.100000       145140         1.11
       0.678     0.200000       290417         1.25
       0.931     0.300000       435508         1.43
       1.151     0.400000       580614         1.67
       1.340     0.500000       725483         2.00
       1.451     0.550000       797508         2.22
       1.631     0.600000       870155         2.50
       1.840     0.650000       942608         2.86
       2.071     0.700000      1015428         3.33
       2.329     0.750000      1087784         4.00
       2.483     0.775000      1123944         4.44
       3.907     0.800000      1159976         5.00
      50.431     0.825000      1196227         5.71
     311.807     0.850000      1232490         6.67
     659.967     0.875000      1268727         8.00
     802.303     0.887500      1286864         8.89
     945.151     0.900000      1304995        10.00
    1114.111     0.912500      1323185        11.43
    1267.711     0.925000      1341228        13.33
    1482.751     0.937500      1359412        16.00
    1584.127     0.943750      1368491        17.78
    1691.647     0.950000      1377504        20.00
    1783.807     0.956250      1386604        22.86
    1878.015     0.962500      1395655        26.67
    1980.415     0.968750      1404669        32.00
    2028.543     0.971875      1409268        35.56
    2081.791     0.975000      1413727        40.00
    2140.159     0.978125      1418384        45.71
    2209.791     0.981250      1422894        53.33
    2297.855     0.984375      1427328        64.00
    2340.863     0.985938      1429609        71.11
    2385.919     0.987500      1431929        80.00
    2426.879     0.989062      1434145        91.43
    2476.031     0.990625      1436457       106.67
    2535.423     0.992188      1438663       128.00
    2564.095     0.992969      1439827       142.22
    2588.671     0.993750      1441002       160.00
    2611.199     0.994531      1442145       182.86
    2637.823     0.995313      1443284       213.33
    2654.207     0.996094      1444321       256.00
    2672.639     0.996484      1444900       284.44
    2695.167     0.996875      1445446       320.00
    2717.695     0.997266      1446010       365.71
    2740.223     0.997656      1446654       426.67
    2756.607     0.998047      1447220       512.00
    2762.751     0.998242      1447462       568.89
    2772.991     0.998437      1447728       640.00
    2781.183     0.998633      1448046       731.43
    2785.279     0.998828      1448289       853.33
    2789.375     0.999023      1448565      1024.00
    2791.423     0.999121      1448708      1137.78
    2795.519     0.999219      1448888      1280.00
    2799.615     0.999316      1448996      1462.86
    2807.807     0.999414      1449157      1706.67
    2815.999     0.999512      1449288      2048.00
    2820.095     0.999561      1449364      2275.56
    2824.191     0.999609      1449423      2560.00
    2828.287     0.999658      1449495      2925.71
    2832.383     0.999707      1449564      3413.33
    2836.479     0.999756      1449627      4096.00
    2838.527     0.999780      1449684      4551.11
    2840.575     0.999805      1449720      5120.00
    2842.623     0.999829      1449741      5851.43
    2846.719     0.999854      1449767      6826.67
    2850.815     0.999878      1449796      8192.00
    2852.863     0.999890      1449810      9102.22
    2856.959     0.999902      1449838     10240.00
    2859.007     0.999915      1449855     11702.86
    2861.055     0.999927      1449870     13653.33
    2863.103     0.999939      1449883     16384.00
    2865.151     0.999945      1449896     18204.44
    2867.199     0.999951      1449909     20480.00
    2867.199     0.999957      1449909     23405.71
    2869.247     0.999963      1449923     27306.67
    2871.295     0.999969      1449936     32768.00
    2871.295     0.999973      1449936     36408.89
    2871.295     0.999976      1449936     40960.00
    2873.343     0.999979      1449950     46811.43
    2873.343     0.999982      1449950     54613.33
    2873.343     0.999985      1449950     65536.00
    2873.343     0.999986      1449950     72817.78
    2875.391     0.999988      1449969     81920.00
    2875.391     1.000000      1449969          inf
#[Mean    =      209.677, StdDeviation   =      547.930]
#[Max     =     2873.344, Total count    =      1449969]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1499990 requests in 5.00m, 95.84MB read
  Socket errors: connect 0, read 0, write 0, timeout 5
Requests/sec:   4999.96
Transfer/sec:    327.15KB
```

[Результаты профилирования `cpu`](put-cpu.html)
[Результаты профилирования `alloc`](put-mem.html)

Выводы:
* Наблюдается резкий рост задержки между 75-ым перцентилем и 90-ым -- c 2ms до 954ms -- это связано с тем, что большая часть запросов взаимодействует с быстрой оперативной памятью, а для выполнения некоторых приходится записывать сразу много данных на диск.
* Согласно графику профилирования `cpu`, чтение запроса из сокета заняло 13.36% всего времени, а также 19.39% времени ушло на запись ответа в сокет. Эти показатели довольно сложно оптимизировать, так как это часть сетевого взаимодействия.
* Ответы на запросы сервером заняли 22.49% времени, из них 17.79% отводится на `flush` в `SSTable`, а 4.07% - в `ConcurrentSkipListMap.put`. Понятно, что запись во внешнюю память будет всегда сильно дольше записи в оперативную, но это можно пытаться оптимизировать.
  Одной из возможных оптимизаций я вижу уменьшение количества запросов к диску до одного на один `flush` -- по графику видно, что на данный момент запись на диск вызывается как минимум из трех разных мест.
* Также, так как наш сервер в данный момент однопоточный, каждый вызов `SSTable.flush` тормозит ответ пользователю, хотя можно было бы это делать асинхронно.
* Касательно количества аллокаций - в текущей реализации аллокации в `LsmDao.upsert` составляют всего 10.46% от общего количества. Однако сильно выделяется 15.11% аллокаций в `Record.of` -- в этом методе целиком копируются 2 байт буффера. Возможной оптимизацией здесь может быть избавление от этого копирования, но в таком случае придется пожертвовать безопасностью.
* Также большое количество аллокаций -- 31.19% тратится на инициализацию строк из массивов байтов. Так как в конце концов БД хранит не строки, а байт буфферы, эту часть можно оптимизировать, и не переводить лишний раз байты в строку, а строку обратно в байты.

### GET запросами на стабильной нагрузке по наполненной БД

Был использован скрипт `get.lua`:
```lua
counter = 0
request = function()
	path = "/v0/entity?id=key" .. counter
	wrk.method = "GET"
	counter = counter + 1
	return wrk.format(nil, path)
end
```

Нагрузочное тестирование запускалось следующей командой:
```
wrk2 -R5000  -c1 -t1 -d5m -s stage1/scripts/get.lua -L http://localhost:8080 > stage1/report/get-wrk-output
```

Консольный вывод wrk2:
```
Running 5m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 117.734ms, rate sampling interval: 1118ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   544.19ms    1.40s    6.05s    88.66%
    Req/Sec     5.00k     1.19k   10.62k    84.17%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.38ms
 75.000%   68.86ms
 90.000%    2.59s 
 99.000%    5.70s 
 99.900%    6.03s 
 99.990%    6.05s 
 99.999%    6.06s 
100.000%    6.06s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.076     0.000000            1         1.00
       0.406     0.100000       145120         1.11
       0.676     0.200000       290324         1.25
       0.927     0.300000       435221         1.43
       1.160     0.400000       580318         1.67
       1.379     0.500000       725518         2.00
       1.633     0.550000       797555         2.22
       2.311     0.600000       870049         2.50
       5.139     0.650000       942498         2.86
      24.463     0.700000      1014989         3.33
      68.863     0.750000      1087532         4.00
     106.815     0.775000      1123740         4.44
     172.415     0.800000      1159979         5.00
     275.199     0.825000      1196259         5.71
     607.231     0.850000      1232491         6.67
    1224.703     0.875000      1268775         8.00
    1990.655     0.887500      1286866         8.89
    2590.719     0.900000      1304968        10.00
    3018.751     0.912500      1323167        11.43
    3686.399     0.925000      1341357        13.33
    4272.127     0.937500      1359395        16.00
    4534.271     0.943750      1368581        17.78
    4698.111     0.950000      1378161        20.00
    4759.551     0.956250      1386798        22.86
    4923.391     0.962500      1395674        26.67
    5160.959     0.968750      1404743        32.00
    5283.839     0.971875      1409406        35.56
    5357.567     0.975000      1413839        40.00
    5455.871     0.978125      1418250        45.71
    5529.599     0.981250      1422975        53.33
    5582.847     0.984375      1427644        64.00
    5599.231     0.985938      1429775        71.11
    5631.999     0.987500      1431899        80.00
    5677.055     0.989062      1434391        91.43
    5709.823     0.990625      1436534       106.67
    5787.647     0.992188      1438693       128.00
    5816.319     0.992969      1440014       142.22
    5836.799     0.993750      1440921       160.00
    5869.567     0.994531      1442260       182.86
    5885.951     0.995313      1443227       213.33
    5910.527     0.996094      1444304       256.00
    5922.815     0.996484      1445122       284.44
    5926.911     0.996875      1445554       320.00
    5951.487     0.997266      1446036       365.71
    5984.255     0.997656      1446725       426.67
    5988.351     0.998047      1447247       512.00
    5996.543     0.998242      1447439       568.89
    6008.831     0.998437      1447798       640.00
    6017.023     0.998633      1448090       731.43
    6021.119     0.998828      1448415       853.33
    6025.215     0.999023      1448666      1024.00
    6029.311     0.999121      1448783      1137.78
    6033.407     0.999219      1448870      1280.00
    6041.599     0.999316      1449078      1462.86
    6045.695     0.999414      1449185      1706.67
    6049.791     0.999512      1449356      2048.00
    6049.791     0.999561      1449356      2275.56
    6053.887     0.999609      1449896      2560.00
    6053.887     0.999658      1449896      2925.71
    6053.887     0.999707      1449896      3413.33
    6053.887     0.999756      1449896      4096.00
    6053.887     0.999780      1449896      4551.11
    6053.887     0.999805      1449896      5120.00
    6053.887     0.999829      1449896      5851.43
    6053.887     0.999854      1449896      6826.67
    6053.887     0.999878      1449896      8192.00
    6053.887     0.999890      1449896      9102.22
    6053.887     0.999902      1449896     10240.00
    6053.887     0.999915      1449896     11702.86
    6053.887     0.999927      1449896     13653.33
    6053.887     0.999939      1449896     16384.00
    6053.887     0.999945      1449896     18204.44
    6053.887     0.999951      1449896     20480.00
    6057.983     0.999957      1449963     23405.71
    6057.983     1.000000      1449963          inf
#[Mean    =      544.192, StdDeviation   =     1395.539]
#[Max     =     6053.888, Total count    =      1449963]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1499985 requests in 5.00m, 106.22MB read
Requests/sec:   4999.95
Transfer/sec:    362.56KB
```

[Результаты профилирования `cpu`](get-cpu.html)
[Результаты профилирования `alloc`](get-mem.html)

Выводы:
* Наблюдается резкий рост задержки между 75-ым перцентилем и 90-ым -- c 68ms до 2.59s -- это связано с тем, что большая часть запросов взаимодействует с быстрой оперативной памятью, а для выполнения некоторых необходимо прочитать данные с диска.
* Согласно графику профилирования `cpu`, чтение запроса из сокета заняло 5.73% всего времени, а также 16.22% времени ушло на запись ответа в сокет. Эти показатели довольно сложно оптимизировать, так как это часть сетевого взаимодействия.
* Получение ответов на запросы сервером заняло 53.12% общего времени, из которых 40.21% ушло на получение данных из `SSTable` и всего 1% на получение данных из `ConcurrentSkipListMap`. Такие большие числа обусловлены тем, что на каждый `GET` запрос производится чтение данных с диска - поиск небходимого `range`.
  Так как мы знаем, что от БД нам на данный момент не нужно ничего, кроме получения значения по ключу - этот момент можно адаптировать под наши нужды и, например, не искать данные на диске, если они уже нашлись в оперативной памяти.
* Также проблему долгих запросов помогло бы решить добавление кеша, однако на данном конкретном тесте все `GET` запросы уникальны, и, следовательно, такая оптимизация только ухудшила бы положение дел.
* При `GET` запросах наибольшее количество аллокаций происходит в итераторах во время поиска следующего элемента -- 65.36%. Это объясняется тем, что БД представляет из себя дерево. При этом сама инициализация итераторов -- метод `LsmDAO.merge` -- составляет всего 15.40% от общего числа аллокаций.