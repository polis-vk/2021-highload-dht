# 2021-highload-dht
Курсовой проект 2021 года [курса](https://polis.mail.ru/curriculum/program/discipline/1257/) "Проектирование высоконагруженных систем" в [Технополис](https://polis.mail.ru).

## Этап 2. Многопоточность. Отчёт

### Нагрузочное тестирование с помощью wrk2
Поскольку предыдущее тестирование выполнялось,
исползуя одно соединение и один поток, то для репрезентативности
экспериментов приведём результаты тестирования до произведённых 
оптимизаций.

Произведём нагрузочное тестирование с помощью wrk2
в течении десяти минут, используя 128 активных соединений,
в четыре потока и поддерживая количество запросов на 
уровне 2000 запросов/с.

#### PUT-запросами:
###### До оптимизаций:
```
$ wrk2 -c 128 -t 4 -d 10m -R 2002 -L -s src/main/resources/wrk/put.lua http://127.0.0.1:8080
Running 10m test @ http://127.0.0.1:8080
  4 threads and 128 connections
  Thread calibration: mean lat.: 1.582ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.586ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.585ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.572ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.48ms    4.52ms 207.62ms   98.28%
    Req/Sec   527.19    189.25    11.67k    91.10%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.03ms
 75.000%    1.36ms
 90.000%    1.68ms
 99.000%   20.82ms
 99.900%   49.25ms
 99.990%  170.37ms
 99.999%  202.62ms
100.000%  207.74ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.053     0.000000            1         1.00
       0.425     0.100000       118138         1.11
       0.599     0.200000       236431         1.25
       0.752     0.300000       354894         1.43
       0.893     0.400000       472938         1.67
       1.028     0.500000       590598         2.00
       1.094     0.550000       649746         2.22
       1.159     0.600000       709122         2.50
       1.223     0.650000       767713         2.86
       1.289     0.700000       826926         3.33
       1.361     0.750000       886207         4.00
       1.400     0.775000       915226         4.44
       1.443     0.800000       944884         5.00
       1.490     0.825000       974305         5.71
       1.543     0.850000      1003856         6.67
       1.605     0.875000      1033504         8.00
       1.640     0.887500      1048299         8.89
       1.679     0.900000      1063000        10.00
       1.723     0.912500      1077669        11.43
       1.773     0.925000      1092344        13.33
       1.833     0.937500      1107112        16.00
       1.868     0.943750      1114499        17.78
       1.908     0.950000      1121937        20.00
       1.954     0.956250      1129268        22.86
       2.012     0.962500      1136652        26.67
       2.089     0.968750      1144036        32.00
       2.141     0.971875      1147758        35.56
       2.215     0.975000      1151435        40.00
       2.349     0.978125      1155067        45.71
       3.501     0.981250      1158727        53.33
       9.199     0.984375      1162418        64.00
      12.471     0.985938      1164264        71.11
      15.639     0.987500      1166110        80.00
      18.815     0.989062      1167953        91.43
      22.047     0.990625      1169797       106.67
      25.263     0.992188      1171645       128.00
      26.943     0.992969      1172569       142.22
      28.559     0.993750      1173492       160.00
      30.351     0.994531      1174413       182.86
      32.143     0.995313      1175337       213.33
      34.207     0.996094      1176259       256.00
      35.423     0.996484      1176728       284.44
      36.703     0.996875      1177180       320.00
      38.111     0.997266      1177645       365.71
      39.583     0.997656      1178106       426.67
      41.759     0.998047      1178568       512.00
      43.007     0.998242      1178792       568.89
      44.159     0.998437      1179023       640.00
      45.471     0.998633      1179254       731.43
      47.519     0.998828      1179487       853.33
      49.471     0.999023      1179718      1024.00
      51.295     0.999121      1179832      1137.78
      53.279     0.999219      1179945      1280.00
      56.191     0.999316      1180061      1462.86
      60.799     0.999414      1180179      1706.67
      71.167     0.999512      1180292      2048.00
      77.887     0.999561      1180349      2275.56
      87.551     0.999609      1180406      2560.00
     101.055     0.999658      1180465      2925.71
     113.599     0.999707      1180522      3413.33
     128.447     0.999756      1180579      4096.00
     136.063     0.999780      1180609      4551.11
     144.255     0.999805      1180638      5120.00
     151.295     0.999829      1180667      5851.43
     158.847     0.999854      1180697      6826.67
     164.991     0.999878      1180723      8192.00
     168.575     0.999890      1180738      9102.22
     170.879     0.999902      1180753     10240.00
     174.335     0.999915      1180767     11702.86
     177.407     0.999927      1180782     13653.33
     180.479     0.999939      1180795     16384.00
     182.911     0.999945      1180803     18204.44
     184.831     0.999951      1180810     20480.00
     186.111     0.999957      1180817     23405.71
     188.159     0.999963      1180824     27306.67
     190.463     0.999969      1180832     32768.00
     191.103     0.999973      1180835     36408.89
     193.791     0.999976      1180840     40960.00
     194.047     0.999979      1180842     46811.43
     195.071     0.999982      1180846     54613.33
     199.039     0.999985      1180850     65536.00
     199.167     0.999986      1180851     72817.78
     199.295     0.999988      1180854     81920.00
     202.623     0.999989      1180855     93622.86
     203.647     0.999991      1180857    109226.67
     203.775     0.999992      1180859    131072.00
     203.775     0.999993      1180859    145635.56
     203.903     0.999994      1180861    163840.00
     203.903     0.999995      1180861    187245.71
     205.055     0.999995      1180862    218453.33
     206.719     0.999996      1180863    262144.00
     206.719     0.999997      1180863    291271.11
     206.975     0.999997      1180864    327680.00
     206.975     0.999997      1180864    374491.43
     207.231     0.999998      1180865    436906.67
     207.231     0.999998      1180865    524288.00
     207.231     0.999998      1180865    582542.22
     207.359     0.999998      1180866    655360.00
     207.359     0.999999      1180866    748982.86
     207.359     0.999999      1180866    873813.33
     207.359     0.999999      1180866   1048576.00
     207.359     0.999999      1180866   1165084.44
     207.743     0.999999      1180867   1310720.00
     207.743     1.000000      1180867          inf
#[Mean    =        1.484, StdDeviation   =        4.519]
#[Max     =      207.616, Total count    =      1180867]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1201116 requests in 10.00m, 76.75MB read
Requests/sec:   2001.85
Transfer/sec:    130.98KB
```

[put_cpu_old.html](put_cpu_old.html) </br>
[put_mem_old.html](put_mem_old.html) </br>
[put_lock_old.html](put_lock_old.html)

###### С буфферизированной записью `SSTable`:
```
$ wrk2 -c 128 -t 4 -d 10m -R 2002 -L -s src/main/resources/wrk/put.lua http://127.0.0.1:8080
Running 10m test @ http://127.0.0.1:8080
  4 threads and 128 connections
  Thread calibration: mean lat.: 1.366ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.388ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.371ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.377ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.39ms    3.32ms 117.70ms   98.40%
    Req/Sec   527.11    176.78     6.89k    91.56%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.03ms
 75.000%    1.37ms
 90.000%    1.69ms
 99.000%   16.86ms
 99.900%   44.51ms
 99.990%   79.68ms
 99.999%  108.86ms
100.000%  117.76ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.058     0.000000            1         1.00
       0.425     0.100000       118242         1.11
       0.597     0.200000       236683         1.25
       0.751     0.300000       354996         1.43
       0.894     0.400000       472715         1.67
       1.031     0.500000       591144         2.00
       1.097     0.550000       649521         2.22
       1.163     0.600000       708777         2.50
       1.229     0.650000       768113         2.86
       1.296     0.700000       826835         3.33
       1.369     0.750000       885710         4.00
       1.410     0.775000       915817         4.44
       1.453     0.800000       945102         5.00
       1.501     0.825000       974792         5.71
       1.554     0.850000      1003974         6.67
       1.615     0.875000      1033345         8.00
       1.649     0.887500      1048148         8.89
       1.687     0.900000      1063091        10.00
       1.729     0.912500      1077645        11.43
       1.778     0.925000      1092380        13.33
       1.835     0.937500      1107096        16.00
       1.868     0.943750      1114489        17.78
       1.905     0.950000      1121877        20.00
       1.948     0.956250      1129209        22.86
       2.002     0.962500      1136690        26.67
       2.073     0.968750      1144086        32.00
       2.119     0.971875      1147784        35.56
       2.177     0.975000      1151360        40.00
       2.263     0.978125      1155042        45.71
       2.459     0.981250      1158729        53.33
       5.423     0.984375      1162418        64.00
       8.495     0.985938      1164263        71.11
      11.719     0.987500      1166111        80.00
      14.991     0.989062      1167953        91.43
      18.239     0.990625      1169799       106.67
      21.567     0.992188      1171649       128.00
      23.311     0.992969      1172572       142.22
      25.103     0.993750      1173493       160.00
      26.799     0.994531      1174419       182.86
      28.831     0.995313      1175339       213.33
      30.911     0.996094      1176258       256.00
      32.015     0.996484      1176719       284.44
      33.215     0.996875      1177178       320.00
      34.591     0.997266      1177643       365.71
      36.095     0.997656      1178103       426.67
      37.919     0.998047      1178570       512.00
      38.975     0.998242      1178796       568.89
      40.127     0.998437      1179026       640.00
      41.311     0.998633      1179260       731.43
      42.815     0.998828      1179485       853.33
      44.767     0.999023      1179717      1024.00
      45.791     0.999121      1179833      1137.78
      46.943     0.999219      1179948      1280.00
      48.415     0.999316      1180061      1462.86
      50.271     0.999414      1180180      1706.67
      52.223     0.999512      1180292      2048.00
      53.343     0.999561      1180351      2275.56
      54.559     0.999609      1180407      2560.00
      56.511     0.999658      1180465      2925.71
      58.943     0.999707      1180524      3413.33
      62.335     0.999756      1180580      4096.00
      63.839     0.999780      1180609      4551.11
      66.559     0.999805      1180638      5120.00
      68.863     0.999829      1180667      5851.43
      72.447     0.999854      1180696      6826.67
      75.583     0.999878      1180724      8192.00
      78.463     0.999890      1180739      9102.22
      80.383     0.999902      1180753     10240.00
      84.351     0.999915      1180768     11702.86
      87.743     0.999927      1180782     13653.33
      89.663     0.999939      1180798     16384.00
      92.095     0.999945      1180804     18204.44
      93.503     0.999951      1180811     20480.00
      94.463     0.999957      1180818     23405.71
      95.615     0.999963      1180825     27306.67
      98.559     0.999969      1180832     32768.00
      98.943     0.999973      1180836     36408.89
     100.095     0.999976      1180840     40960.00
     100.863     0.999979      1180843     46811.43
     103.615     0.999982      1180847     54613.33
     104.383     0.999985      1180850     65536.00
     107.647     0.999986      1180852     72817.78
     108.351     0.999988      1180854     81920.00
     108.863     0.999989      1180856     93622.86
     110.015     0.999991      1180858    109226.67
     110.079     0.999992      1180859    131072.00
     112.383     0.999993      1180860    145635.56
     113.407     0.999994      1180861    163840.00
     113.599     0.999995      1180862    187245.71
     114.239     0.999995      1180864    218453.33
     114.239     0.999996      1180864    262144.00
     114.239     0.999997      1180864    291271.11
     114.303     0.999997      1180866    327680.00
     114.303     0.999997      1180866    374491.43
     114.303     0.999998      1180866    436906.67
     114.303     0.999998      1180866    524288.00
     114.303     0.999998      1180866    582542.22
     114.879     0.999998      1180867    655360.00
     114.879     0.999999      1180867    748982.86
     114.879     0.999999      1180867    873813.33
     114.879     0.999999      1180867   1048576.00
     114.879     0.999999      1180867   1165084.44
     117.759     0.999999      1180868   1310720.00
     117.759     1.000000      1180868          inf
#[Mean    =        1.389, StdDeviation   =        3.317]
#[Max     =      117.696, Total count    =      1180868]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1201116 requests in 10.00m, 76.75MB read
Requests/sec:   2001.85
Transfer/sec:    130.98KB
```

[put_cpu_buffered.html](put_cpu_buffered.html) </br>
[put_mem_buffered.html](put_mem_buffered.html) </br>
[put_lock_buffered.html](put_lock_buffered.html)

Данная оптимизация уменьшила разрыв между квантилями при
нагрузочном тестировании, уменьшилось максимальное время 
обработки запроса.
В профиле видно, что две ветки вызова системного метода
`write` объединились одну.

###### Оптимизация критической секции и асинхронное выполнение `flush()`:
```
$ wrk2 -c 128 -t 4 -d 10m -R 2002 -L -s src/main/resources/wrk/put.lua http://127.0.0.1:8080
Running 10m test @ http://127.0.0.1:8080
  4 threads and 128 connections
  Thread calibration: mean lat.: 1.080ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.076ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.289ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.099ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.08ms  505.91us  36.93ms   67.40%
    Req/Sec   526.99    387.34     2.11k    76.24%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.06ms
 75.000%    1.41ms
 90.000%    1.71ms
 99.000%    2.23ms
 99.900%    2.92ms
 99.990%    6.51ms
 99.999%   24.33ms
100.000%   36.96ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.049     0.000000            1         1.00
       0.436     0.100000       118277         1.11
       0.613     0.200000       236564         1.25
       0.771     0.300000       354633         1.43
       0.921     0.400000       472607         1.67
       1.064     0.500000       590770         2.00
       1.134     0.550000       650163         2.22
       1.202     0.600000       709062         2.50
       1.269     0.650000       768024         2.86
       1.338     0.700000       827027         3.33
       1.412     0.750000       885889         4.00
       1.451     0.775000       915397         4.44
       1.493     0.800000       945228         5.00
       1.538     0.825000       974269         5.71
       1.588     0.850000      1003907         6.67
       1.644     0.875000      1033299         8.00
       1.675     0.887500      1048027         8.89
       1.709     0.900000      1062894        10.00
       1.746     0.912500      1077747        11.43
       1.787     0.925000      1092363        13.33
       1.834     0.937500      1107227        16.00
       1.860     0.943750      1114471        17.78
       1.889     0.950000      1121974        20.00
       1.920     0.956250      1129218        22.86
       1.956     0.962500      1136714        26.67
       1.996     0.968750      1143968        32.00
       2.019     0.971875      1147647        35.56
       2.045     0.975000      1151469        40.00
       2.073     0.978125      1155212        45.71
       2.103     0.981250      1158735        53.33
       2.141     0.984375      1162462        64.00
       2.163     0.985938      1164334        71.11
       2.187     0.987500      1166152        80.00
       2.213     0.989062      1167999        91.43
       2.245     0.990625      1169885       106.67
       2.279     0.992188      1171676       128.00
       2.301     0.992969      1172604       142.22
       2.325     0.993750      1173507       160.00
       2.353     0.994531      1174437       182.86
       2.387     0.995313      1175361       213.33
       2.425     0.996094      1176243       256.00
       2.451     0.996484      1176701       284.44
       2.479     0.996875      1177183       320.00
       2.513     0.997266      1177641       365.71
       2.553     0.997656      1178083       426.67
       2.605     0.998047      1178542       512.00
       2.643     0.998242      1178774       568.89
       2.691     0.998437      1179002       640.00
       2.757     0.998633      1179243       731.43
       2.827     0.998828      1179463       853.33
       2.939     0.999023      1179696      1024.00
       3.035     0.999121      1179809      1137.78
       3.151     0.999219      1179929      1280.00
       3.273     0.999316      1180039      1462.86
       3.437     0.999414      1180156      1706.67
       3.597     0.999512      1180270      2048.00
       3.707     0.999561      1180328      2275.56
       3.827     0.999609      1180385      2560.00
       3.973     0.999658      1180443      2925.71
       4.103     0.999707      1180501      3413.33
       4.315     0.999756      1180558      4096.00
       4.423     0.999780      1180589      4551.11
       4.607     0.999805      1180616      5120.00
       4.923     0.999829      1180646      5851.43
       5.343     0.999854      1180674      6826.67
       5.855     0.999878      1180702      8192.00
       6.239     0.999890      1180717      9102.22
       6.623     0.999902      1180731     10240.00
       7.371     0.999915      1180746     11702.86
       8.455     0.999927      1180760     13653.33
       9.831     0.999939      1180774     16384.00
      10.431     0.999945      1180782     18204.44
      11.287     0.999951      1180789     20480.00
      11.551     0.999957      1180796     23405.71
      12.311     0.999963      1180803     27306.67
      13.575     0.999969      1180810     32768.00
      15.471     0.999973      1180814     36408.89
      17.103     0.999976      1180818     40960.00
      17.471     0.999979      1180821     46811.43
      18.575     0.999982      1180825     54613.33
      20.207     0.999985      1180828     65536.00
      20.975     0.999986      1180830     72817.78
      21.743     0.999988      1180832     81920.00
      24.335     0.999989      1180834     93622.86
      25.583     0.999991      1180836    109226.67
      25.791     0.999992      1180837    131072.00
      26.607     0.999993      1180838    145635.56
      26.863     0.999994      1180839    163840.00
      27.247     0.999995      1180840    187245.71
      29.887     0.999995      1180841    218453.33
      30.367     0.999996      1180842    262144.00
      30.367     0.999997      1180842    291271.11
      30.799     0.999997      1180843    327680.00
      30.799     0.999997      1180843    374491.43
      31.903     0.999998      1180844    436906.67
      31.903     0.999998      1180844    524288.00
      31.903     0.999998      1180844    582542.22
      36.383     0.999998      1180845    655360.00
      36.383     0.999999      1180845    748982.86
      36.383     0.999999      1180845    873813.33
      36.383     0.999999      1180845   1048576.00
      36.383     0.999999      1180845   1165084.44
      36.959     0.999999      1180846   1310720.00
      36.959     1.000000      1180846          inf
#[Mean    =        1.076, StdDeviation   =        0.506]
#[Max     =       36.928, Total count    =      1180846]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1200651 requests in 10.00m, 76.72MB read
Requests/sec:   2001.04
Transfer/sec:    130.93KB
```
[put_cpu_async.html](put_cpu_async.html) </br>
[put_mem_async.html](put_mem_async.html) </br>
[put_lock_async.html](put_lock_async.html)

Данная оптимизация перенесла разрыв между квантилями на 
два знака после запятой. Уменьшилось максимальное
время обработки запроса.
В профиле можно увидеть значительное уменьшение числа блокировок
(1907 против 28).
Блокировки происходят тогда, когда необходимо
произвести несколько вызовов `flush` одновременно.


#### GET запросами:
###### До оптимизаций:
```
$ wrk2 -c 128 -t 4 -d 10m -R 1998 -L -s src/main/resources/wrk/get.lua http://127.0.0.1:8080
Running 10m test @ http://127.0.0.1:8080
  4 threads and 128 connections
  Thread calibration: mean lat.: 371.451ms, rate sampling interval: 2721ms
  Thread calibration: mean lat.: 450.797ms, rate sampling interval: 3338ms
  Thread calibration: mean lat.: 451.941ms, rate sampling interval: 3463ms
  Thread calibration: mean lat.: 459.037ms, rate sampling interval: 3428ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    12.34ms  116.20ms   5.59s    98.60%
    Req/Sec   499.10      8.97   575.00     95.37%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.70ms
 75.000%    2.33ms
 90.000%    3.34ms
 99.000%  273.92ms
 99.900%    1.68s
 99.990%    4.48s
 99.999%    5.51s
100.000%    5.60s

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.362     0.000000            1         1.00
       0.911     0.100000       117916         1.11
       1.142     0.200000       235735         1.25
       1.336     0.300000       353928         1.43
       1.514     0.400000       471720         1.67
       1.698     0.500000       589755         2.00
       1.798     0.550000       648623         2.22
       1.906     0.600000       707258         2.50
       2.026     0.650000       766255         2.86
       2.161     0.700000       825100         3.33
       2.325     0.750000       884378         4.00
       2.423     0.775000       913617         4.44
       2.537     0.800000       943116         5.00
       2.669     0.825000       972685         5.71
       2.833     0.850000      1001947         6.67
       3.045     0.875000      1031298         8.00
       3.179     0.887500      1046048         8.89
       3.343     0.900000      1060777        10.00
       3.551     0.912500      1075474        11.43
       3.837     0.925000      1090148        13.33
       4.287     0.937500      1104916        16.00
       4.639     0.943750      1112245        17.78
       5.183     0.950000      1119573        20.00
       6.183     0.956250      1126948        22.86
       8.679     0.962500      1134311        26.67
      15.143     0.968750      1141672        32.00
      20.911     0.971875      1145358        35.56
      28.463     0.975000      1149034        40.00
      40.447     0.978125      1152717        45.71
      60.703     0.981250      1156399        53.33
      99.007     0.984375      1160085        64.00
     128.255     0.985938      1161925        71.11
     172.543     0.987500      1163765        80.00
     229.247     0.989062      1165606        91.43
     308.479     0.990625      1167450       106.67
     419.327     0.992188      1169290       128.00
     473.343     0.992969      1170209       142.22
     526.847     0.993750      1171130       160.00
     597.503     0.994531      1172056       182.86
     678.911     0.995313      1172971       213.33
     782.335     0.996094      1173891       256.00
     850.431     0.996484      1174354       284.44
     927.231     0.996875      1174813       320.00
    1003.007     0.997266      1175273       365.71
    1085.439     0.997656      1175733       426.67
    1204.223     0.998047      1176193       512.00
    1326.079     0.998242      1176425       568.89
    1423.359     0.998437      1176654       640.00
    1523.711     0.998633      1176883       731.43
    1605.631     0.998828      1177114       853.33
    1697.791     0.999023      1177347      1024.00
    1764.351     0.999121      1177460      1137.78
    1827.839     0.999219      1177574      1280.00
    1891.327     0.999316      1177689      1462.86
    1952.767     0.999414      1177805      1706.67
    2115.583     0.999512      1177919      2048.00
    2279.423     0.999561      1177977      2275.56
    2443.263     0.999609      1178035      2560.00
    2629.631     0.999658      1178093      2925.71
    2873.343     0.999707      1178150      3413.33
    3145.727     0.999756      1178207      4096.00
    3319.807     0.999780      1178236      4551.11
    3457.023     0.999805      1178264      5120.00
    3602.431     0.999829      1178293      5851.43
    3796.991     0.999854      1178322      6826.67
    4177.919     0.999878      1178351      8192.00
    4345.855     0.999890      1178365      9102.22
    4501.503     0.999902      1178379     10240.00
    4665.343     0.999915      1178394     11702.86
    4812.799     0.999927      1178408     13653.33
    4952.063     0.999939      1178423     16384.00
    5038.079     0.999945      1178432     18204.44
    5095.423     0.999951      1178437     20480.00
    5165.055     0.999957      1178444     23405.71
    5226.495     0.999963      1178451     27306.67
    5312.511     0.999969      1178459     32768.00
    5345.279     0.999973      1178462     36408.89
    5382.143     0.999976      1178467     40960.00
    5402.623     0.999979      1178469     46811.43
    5435.391     0.999982      1178473     54613.33
    5459.967     0.999985      1178477     65536.00
    5480.447     0.999986      1178478     72817.78
    5488.639     0.999988      1178480     81920.00
    5509.119     0.999989      1178483     93622.86
    5525.503     0.999991      1178484    109226.67
    5533.695     0.999992      1178486    131072.00
    5533.695     0.999993      1178486    145635.56
    5541.887     0.999994      1178487    163840.00
    5545.983     0.999995      1178488    187245.71
    5550.079     0.999995      1178489    218453.33
    5566.463     0.999996      1178490    262144.00
    5566.463     0.999997      1178490    291271.11
    5570.559     0.999997      1178491    327680.00
    5570.559     0.999997      1178491    374491.43
    5591.039     0.999998      1178493    436906.67
    5591.039     0.999998      1178493    524288.00
    5591.039     0.999998      1178493    582542.22
    5591.039     0.999998      1178493    655360.00
    5591.039     0.999999      1178493    748982.86
    5591.039     0.999999      1178493    873813.33
    5591.039     0.999999      1178493   1048576.00
    5591.039     0.999999      1178493   1165084.44
    5595.135     0.999999      1178494   1310720.00
    5595.135     1.000000      1178494          inf
#[Mean    =       12.339, StdDeviation   =      116.202]
#[Max     =     5591.040, Total count    =      1178494]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1198709 requests in 10.00m, 1.20GB read
Requests/sec:   1997.83
Transfer/sec:      2.04MB
```

[get_cpu_old.html](get_cpu_old.html) </br>
[get_mem_old.html](get_mem_old.html) </br>
[get_lock_old.html](get_lock_old.html)

###### Оптимизация критической секции
```
$ wrk2 -c 128 -t 4 -d 10m -R 1998 -L -s src/main/resources/wrk/get.lua http://127.0.0.1:8080
Running 10m test @ http://127.0.0.1:8080
  4 threads and 128 connections
  Thread calibration: mean lat.: 2.060ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 3.799ms, rate sampling interval: 12ms
  Thread calibration: mean lat.: 2.016ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 3.523ms, rate sampling interval: 11ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.43ms    2.20ms 136.06ms   93.77%
    Req/Sec   525.67    705.92     3.62k    91.05%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.04ms
 75.000%    2.98ms
 90.000%    4.12ms
 99.000%    7.03ms
 99.900%   26.85ms
 99.990%   82.50ms
 99.999%  117.76ms
100.000%  136.19ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.371     0.000000            1         1.00
       1.040     0.100000       117876         1.11
       1.308     0.200000       235712         1.25
       1.543     0.300000       353654         1.43
       1.781     0.400000       471742         1.67
       2.035     0.500000       589528         2.00
       2.177     0.550000       648896         2.22
       2.333     0.600000       707694         2.50
       2.513     0.650000       766093         2.86
       2.725     0.700000       825131         3.33
       2.979     0.750000       884282         4.00
       3.125     0.775000       913595         4.44
       3.283     0.800000       942836         5.00
       3.457     0.825000       972540         5.71
       3.651     0.850000      1001863         6.67
       3.867     0.875000      1031414         8.00
       3.987     0.887500      1046058         8.89
       4.119     0.900000      1060893        10.00
       4.263     0.912500      1075616        11.43
       4.427     0.925000      1090128        13.33
       4.619     0.937500      1104868        16.00
       4.735     0.943750      1112384        17.78
       4.855     0.950000      1119751        20.00
       4.995     0.956250      1127037        22.86
       5.159     0.962500      1134430        26.67
       5.351     0.968750      1141750        32.00
       5.467     0.971875      1145444        35.56
       5.599     0.975000      1149126        40.00
       5.759     0.978125      1152741        45.71
       5.959     0.981250      1156404        53.33
       6.215     0.984375      1160087        64.00
       6.383     0.985938      1161947        71.11
       6.571     0.987500      1163789        80.00
       6.839     0.989062      1165644        91.43
       7.187     0.990625      1167454       106.67
       7.751     0.992188      1169300       128.00
       8.167     0.992969      1170218       142.22
       8.711     0.993750      1171133       160.00
       9.375     0.994531      1172061       182.86
      10.239     0.995313      1172972       213.33
      11.407     0.996094      1173896       256.00
      12.095     0.996484      1174354       284.44
      12.855     0.996875      1174813       320.00
      13.815     0.997266      1175274       365.71
      15.119     0.997656      1175734       426.67
      17.071     0.998047      1176195       512.00
      18.207     0.998242      1176425       568.89
      19.711     0.998437      1176655       640.00
      21.535     0.998633      1176887       731.43
      23.247     0.998828      1177115       853.33
      27.375     0.999023      1177345      1024.00
      29.279     0.999121      1177463      1137.78
      31.135     0.999219      1177575      1280.00
      32.927     0.999316      1177693      1462.86
      34.655     0.999414      1177806      1706.67
      38.911     0.999512      1177920      2048.00
      42.559     0.999561      1177978      2275.56
      46.527     0.999609      1178035      2560.00
      49.791     0.999658      1178093      2925.71
      54.687     0.999707      1178150      3413.33
      60.479     0.999756      1178208      4096.00
      62.655     0.999780      1178237      4551.11
      68.159     0.999805      1178265      5120.00
      73.279     0.999829      1178294      5851.43
      75.071     0.999854      1178324      6826.67
      76.159     0.999878      1178354      8192.00
      79.231     0.999890      1178366      9102.22
      82.687     0.999902      1178381     10240.00
      84.991     0.999915      1178395     11702.86
      87.167     0.999927      1178410     13653.33
      91.135     0.999939      1178424     16384.00
      92.543     0.999945      1178431     18204.44
      94.015     0.999951      1178438     20480.00
      96.703     0.999957      1178445     23405.71
      98.303     0.999963      1178452     27306.67
     104.063     0.999969      1178460     32768.00
     105.919     0.999973      1178463     36408.89
     110.143     0.999976      1178467     40960.00
     111.871     0.999979      1178470     46811.43
     114.111     0.999982      1178474     54613.33
     114.687     0.999985      1178478     65536.00
     114.751     0.999986      1178479     72817.78
     116.415     0.999988      1178481     81920.00
     117.759     0.999989      1178483     93622.86
     119.743     0.999991      1178485    109226.67
     123.839     0.999992      1178487    131072.00
     123.839     0.999993      1178487    145635.56
     123.967     0.999994      1178488    163840.00
     124.863     0.999995      1178489    187245.71
     125.183     0.999995      1178490    218453.33
     126.527     0.999996      1178491    262144.00
     126.527     0.999997      1178491    291271.11
     127.167     0.999997      1178492    327680.00
     127.167     0.999997      1178492    374491.43
     127.935     0.999998      1178493    436906.67
     127.935     0.999998      1178493    524288.00
     127.935     0.999998      1178493    582542.22
     128.831     0.999998      1178494    655360.00
     128.831     0.999999      1178494    748982.86
     128.831     0.999999      1178494    873813.33
     128.831     0.999999      1178494   1048576.00
     128.831     0.999999      1178494   1165084.44
     136.191     0.999999      1178495   1310720.00
     136.191     1.000000      1178495          inf
#[Mean    =        2.427, StdDeviation   =        2.195]
#[Max     =      136.064, Total count    =      1178495]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1197759 requests in 10.00m, 1.19GB read
Requests/sec:   1996.23
Transfer/sec:      2.04MB
```
[get_cpu_async.html](get_cpu_async.html) </br>
[get_mem_async.html](get_mem_async.html) </br>
[get_lock_async.html](get_lock_async.html)

Данная оптимизация перенесла разрыв между квантилями на один знак,
существенно уменьшилось максимальное время выполнения запроса.
Критическая секция полностью исключена, благодаря использованию
потокобезопасных структур данных и обеспечнию упорядоченной записи
в них.