# 2021-highload-dht
Курсовой проект 2021 года [курса](https://polis.mail.ru/curriculum/program/discipline/1257/) "Проектирование высоконагруженных систем" в [Технополис](https://polis.mail.ru).

## Этап 3. Многопоточность. Отчёт

### Нагрузочное тестирование с помощью wrk2
Произведём нагрузочное тестирование с помощью wrk2
в течении пяти минут, используя 128 активных соединений,
в четыре потока и поддерживая количество запросов на
уровне 2000 запросов/с.

#### PUT-запросами:
###### До оптимизаций:
```
avightclav@DESTOP-AVGHTCLV:~/devel/2021-highload-dht/src/main/resources$ wrk2 -c128 -t4 -d5m -R2002 -L -s wrk/put.lua http://localhost:8080
Running 5m test @ http://localhost:8080
  4 threads and 128 connections
  Thread calibration: mean lat.: 1.938ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.113ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.115ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.936ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.51ms  807.97us  32.72ms   74.24%
    Req/Sec   527.48      0.85k    3.56k    91.91%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.46ms
 75.000%    1.98ms
 90.000%    2.40ms
 99.000%    3.05ms
 99.900%    8.69ms
 99.990%   22.72ms
 99.999%   25.02ms
100.000%   32.74ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.080     0.000000            1         1.00
       0.603     0.100000        58121         1.11
       0.869     0.200000       116100         1.25
       1.091     0.300000       174250         1.43
       1.281     0.400000       232397         1.67
       1.460     0.500000       290360         2.00
       1.554     0.550000       319399         2.22
       1.652     0.600000       348447         2.50
       1.755     0.650000       377256         2.86
       1.866     0.700000       406376         3.33
       1.980     0.750000       435345         4.00
       2.040     0.775000       449726         4.44
       2.103     0.800000       464282         5.00
       2.169     0.825000       478742         5.71
       2.241     0.850000       493402         6.67
       2.315     0.875000       507850         8.00
       2.355     0.887500       514963         8.89
       2.399     0.900000       522440        10.00
       2.445     0.912500       529644        11.43
       2.495     0.925000       536802        13.33
       2.551     0.937500       544055        16.00
       2.581     0.943750       547605        17.78
       2.617     0.950000       551346        20.00
       2.655     0.956250       554910        22.86
       2.699     0.962500       558585        26.67
       2.749     0.968750       562180        32.00
       2.777     0.971875       563955        35.56
       2.811     0.975000       565811        40.00
       2.847     0.978125       567598        45.71
       2.889     0.981250       569454        53.33
       2.937     0.984375       571256        64.00
       2.961     0.985938       572102        71.11
       2.993     0.987500       573055        80.00
       3.025     0.989062       573911        91.43
       3.065     0.990625       574821       106.67
       3.115     0.992188       575727       128.00
       3.145     0.992969       576164       142.22
       3.185     0.993750       576627       160.00
       3.227     0.994531       577065       182.86
       3.285     0.995313       577527       213.33
       3.375     0.996094       577973       256.00
       3.453     0.996484       578199       284.44
       3.565     0.996875       578427       320.00
       3.791     0.997266       578652       365.71
       4.183     0.997656       578879       426.67
       4.731     0.998047       579106       512.00
       5.091     0.998242       579219       568.89
       5.443     0.998437       579336       640.00
       6.007     0.998633       579445       731.43
       7.143     0.998828       579559       853.33
       8.895     0.999023       579672      1024.00
       9.447     0.999121       579729      1137.78
      10.359     0.999219       579785      1280.00
      10.687     0.999316       579842      1462.86
      11.799     0.999414       579899      1706.67
      12.711     0.999512       579955      2048.00
      13.143     0.999561       579984      2275.56
      14.479     0.999609       580012      2560.00
      16.335     0.999658       580040      2925.71
      16.815     0.999707       580070      3413.33
      17.103     0.999756       580097      4096.00
      17.311     0.999780       580111      4551.11
      18.095     0.999805       580125      5120.00
      19.535     0.999829       580139      5851.43
      22.303     0.999854       580154      6826.67
      22.575     0.999878       580168      8192.00
      22.655     0.999890       580175      9102.22
      22.735     0.999902       580187     10240.00
      22.783     0.999915       580189     11702.86
      22.831     0.999927       580198     13653.33
      22.927     0.999939       580203     16384.00
      22.991     0.999945       580207     18204.44
      23.023     0.999951       580210     20480.00
      23.087     0.999957       580214     23405.71
      23.151     0.999963       580218     27306.67
      23.247     0.999969       580221     32768.00
      23.663     0.999973       580223     36408.89
      23.791     0.999976       580224     40960.00
      24.047     0.999979       580226     46811.43
      24.255     0.999982       580228     54613.33
      24.655     0.999985       580230     65536.00
      24.767     0.999986       580231     72817.78
      24.767     0.999988       580231     81920.00
      25.023     0.999989       580232     93622.86
      25.359     0.999991       580233    109226.67
      27.247     0.999992       580234    131072.00
      27.743     0.999993       580235    145635.56
      27.743     0.999994       580235    163840.00
      27.743     0.999995       580235    187245.71
      31.407     0.999995       580236    218453.33
      31.407     0.999996       580236    262144.00
      32.095     0.999997       580237    291271.11
      32.095     0.999997       580237    327680.00
      32.095     0.999997       580237    374491.43
      32.095     0.999998       580237    436906.67
      32.095     0.999998       580237    524288.00
      32.735     0.999998       580238    582542.22
      32.735     1.000000       580238          inf
#[Mean    =        1.508, StdDeviation   =        0.808]
#[Max     =       32.720, Total count    =       580238]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599635 requests in 5.00m, 38.31MB read
Requests/sec:   1998.58
Transfer/sec:    130.77KB
```

[put_cpu_old.html](put_cpu_old.html) </br>
[put_mem_old.html](put_mem_old.html) </br>
[put_lock_old.html](put_lock_old.html)

###### С освобождением селекторов:
```
$ wrk2 -c128 -t4 -d5m -R2002 -L -s wrk/put.lua http://localhost:8080
Running 5m test @ http://localhost:8080
  4 threads and 128 connections
  Thread calibration: mean lat.: 1.149ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.107ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.577ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.126ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.18ms  657.96us  26.82ms   77.57%
    Req/Sec   526.51    577.35     3.56k    95.73%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.14ms
 75.000%    1.50ms
 90.000%    1.89ms
 99.000%    2.68ms
 99.900%    5.01ms
 99.990%   21.66ms
 99.999%   25.26ms
100.000%   26.83ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.095     0.000000            1         1.00
       0.499     0.100000        58052         1.11
       0.685     0.200000       116186         1.25
       0.846     0.300000       174271         1.43
       0.995     0.400000       232201         1.67
       1.138     0.500000       290463         2.00
       1.207     0.550000       319285         2.22
       1.276     0.600000       348597         2.50
       1.345     0.650000       377466         2.86
       1.420     0.700000       406348         3.33
       1.504     0.750000       435341         4.00
       1.550     0.775000       449770         4.44
       1.600     0.800000       464220         5.00
       1.657     0.825000       478750         5.71
       1.723     0.850000       493272         6.67
       1.796     0.875000       507770         8.00
       1.839     0.887500       515094         8.89
       1.886     0.900000       522366        10.00
       1.937     0.912500       529558        11.43
       1.994     0.925000       536734        13.33
       2.061     0.937500       544032        16.00
       2.099     0.943750       547681        17.78
       2.141     0.950000       551394        20.00
       2.185     0.956250       554873        22.86
       2.237     0.962500       558559        26.67
       2.297     0.968750       562117        32.00
       2.335     0.971875       563992        35.56
       2.375     0.975000       565796        40.00
       2.421     0.978125       567620        45.71
       2.471     0.981250       569395        53.33
       2.533     0.984375       571216        64.00
       2.569     0.985938       572127        71.11
       2.605     0.987500       573000        80.00
       2.653     0.989062       573944        91.43
       2.705     0.990625       574826       106.67
       2.771     0.992188       575724       128.00
       2.811     0.992969       576186       142.22
       2.859     0.993750       576630       160.00
       2.919     0.994531       577086       182.86
       2.987     0.995313       577539       213.33
       3.073     0.996094       577990       256.00
       3.125     0.996484       578215       284.44
       3.189     0.996875       578442       320.00
       3.275     0.997266       578666       365.71
       3.375     0.997656       578890       426.67
       3.531     0.998047       579116       512.00
       3.655     0.998242       579231       568.89
       3.861     0.998437       579343       640.00
       4.135     0.998633       579456       731.43
       4.511     0.998828       579571       853.33
       5.123     0.999023       579683      1024.00
       5.375     0.999121       579744      1137.78
       5.679     0.999219       579798      1280.00
       6.371     0.999316       579853      1462.86
       6.907     0.999414       579911      1706.67
       8.423     0.999512       579966      2048.00
      10.159     0.999561       579995      2275.56
      10.967     0.999609       580023      2560.00
      12.079     0.999658       580051      2925.71
      13.791     0.999707       580080      3413.33
      15.351     0.999756       580108      4096.00
      17.519     0.999780       580122      4551.11
      19.823     0.999805       580136      5120.00
      20.655     0.999829       580151      5851.43
      20.975     0.999854       580165      6826.67
      21.471     0.999878       580180      8192.00
      21.583     0.999890       580187      9102.22
      21.679     0.999902       580194     10240.00
      21.839     0.999915       580200     11702.86
      22.159     0.999927       580208     13653.33
      22.943     0.999939       580214     16384.00
      23.439     0.999945       580218     18204.44
      23.663     0.999951       580221     20480.00
      23.775     0.999957       580225     23405.71
      23.855     0.999963       580228     27306.67
      23.967     0.999969       580233     32768.00
      24.031     0.999973       580234     36408.89
      24.543     0.999976       580235     40960.00
      24.671     0.999979       580237     46811.43
      24.767     0.999982       580239     54613.33
      25.167     0.999985       580242     65536.00
      25.167     0.999986       580242     72817.78
      25.167     0.999988       580242     81920.00
      25.263     0.999989       580243     93622.86
      25.279     0.999991       580244    109226.67
      25.375     0.999992       580245    131072.00
      25.439     0.999993       580246    145635.56
      25.439     0.999994       580246    163840.00
      25.439     0.999995       580246    187245.71
      26.655     0.999995       580247    218453.33
      26.655     0.999996       580247    262144.00
      26.751     0.999997       580248    291271.11
      26.751     0.999997       580248    327680.00
      26.751     0.999997       580248    374491.43
      26.751     0.999998       580248    436906.67
      26.751     0.999998       580248    524288.00
      26.831     0.999998       580249    582542.22
      26.831     1.000000       580249          inf
#[Mean    =        1.184, StdDeviation   =        0.658]
#[Max     =       26.816, Total count    =       580249]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  600044 requests in 5.00m, 38.34MB read
Requests/sec:   1999.96
Transfer/sec:    130.86KB
```

[put_cpu.html](put_cpu.html) </br>
[put_mem.html](put_mem.html) </br>
[put_lock.html](put_lock.html)

Небольшое уменьшение максимального времени обработки запроса, 
похожее на стохастическое.


#### GET запросами:
###### До оптимизаций:
```
$ wrk2 -c128 -t4 -d5m -R2000 -L -s wrk/get.lua ht
tp://localhost:8080
Running 5m test @ http://localhost:8080
  4 threads and 128 connections
  Thread calibration: mean lat.: 1.746ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.491ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.498ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.431ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.45ms    1.40ms  87.68ms   98.54%
    Req/Sec   526.64    597.47     3.56k    95.84%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.37ms
 75.000%    1.77ms
 90.000%    2.16ms
 99.000%    3.02ms
 99.900%   11.37ms
 99.990%   65.21ms
 99.999%   82.11ms
100.000%   87.74ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.216     0.000000            1         1.00
       0.698     0.100000        58075         1.11
       0.908     0.200000       116129         1.25
       1.080     0.300000       173941         1.43
       1.228     0.400000       232082         1.67
       1.366     0.500000       289926         2.00
       1.435     0.550000       318981         2.22
       1.508     0.600000       347941         2.50
       1.585     0.650000       376824         2.86
       1.671     0.700000       406048         3.33
       1.766     0.750000       434968         4.00
       1.819     0.775000       449509         4.44
       1.874     0.800000       463782         5.00
       1.933     0.825000       478271         5.71
       1.998     0.850000       492887         6.67
       2.071     0.875000       507434         8.00
       2.111     0.887500       514521         8.89
       2.157     0.900000       521826        10.00
       2.207     0.912500       528980        11.43
       2.263     0.925000       536234        13.33
       2.327     0.937500       543505        16.00
       2.363     0.943750       547114        17.78
       2.403     0.950000       550728        20.00
       2.449     0.956250       554456        22.86
       2.499     0.962500       557937        26.67
       2.561     0.968750       561591        32.00
       2.597     0.971875       563425        35.56
       2.639     0.975000       565206        40.00
       2.689     0.978125       566985        45.71
       2.749     0.981250       568817        53.33
       2.823     0.984375       570624        64.00
       2.867     0.985938       571533        71.11
       2.917     0.987500       572433        80.00
       2.975     0.989062       573320        91.43
       3.055     0.990625       574226       106.67
       3.157     0.992188       575137       128.00
       3.221     0.992969       575589       142.22
       3.303     0.993750       576044       160.00
       3.419     0.994531       576490       182.86
       3.567     0.995313       576948       213.33
       3.771     0.996094       577392       256.00
       3.907     0.996484       577622       284.44
       4.103     0.996875       577846       320.00
       4.355     0.997266       578077       365.71
       4.723     0.997656       578299       426.67
       5.243     0.998047       578524       512.00
       5.591     0.998242       578639       568.89
       6.263     0.998437       578751       640.00
       7.487     0.998633       578864       731.43
       9.687     0.998828       578977       853.33
      11.567     0.999023       579090      1024.00
      13.951     0.999121       579147      1137.78
      18.367     0.999219       579204      1280.00
      22.047     0.999316       579260      1462.86
      27.983     0.999414       579317      1706.67
      32.415     0.999512       579373      2048.00
      36.319     0.999561       579402      2275.56
      40.703     0.999609       579430      2560.00
      45.823     0.999658       579458      2925.71
      47.743     0.999707       579487      3413.33
      51.551     0.999756       579515      4096.00
      52.383     0.999780       579529      4551.11
      54.879     0.999805       579543      5120.00
      56.383     0.999829       579557      5851.43
      60.095     0.999854       579572      6826.67
      63.103     0.999878       579586      8192.00
      63.935     0.999890       579593      9102.22
      65.727     0.999902       579600     10240.00
      67.263     0.999915       579607     11702.86
      68.287     0.999927       579614     13653.33
      70.911     0.999939       579621     16384.00
      71.999     0.999945       579625     18204.44
      73.087     0.999951       579629     20480.00
      74.879     0.999957       579632     23405.71
      76.543     0.999963       579635     27306.67
      77.311     0.999969       579639     32768.00
      78.271     0.999973       579641     36408.89
      78.847     0.999976       579642     40960.00
      79.359     0.999979       579644     46811.43
      79.551     0.999982       579646     54613.33
      81.023     0.999985       579648     65536.00
      81.279     0.999986       579649     72817.78
      81.279     0.999988       579649     81920.00
      82.111     0.999989       579650     93622.86
      82.559     0.999991       579652    109226.67
      82.559     0.999992       579652    131072.00
      83.263     0.999993       579653    145635.56
      83.263     0.999994       579653    163840.00
      83.263     0.999995       579653    187245.71
      87.231     0.999995       579654    218453.33
      87.231     0.999996       579654    262144.00
      87.295     0.999997       579655    291271.11
      87.295     0.999997       579655    327680.00
      87.295     0.999997       579655    374491.43
      87.295     0.999998       579655    436906.67
      87.295     0.999998       579655    524288.00
      87.743     0.999998       579656    582542.22
      87.743     1.000000       579656          inf
#[Mean    =        1.450, StdDeviation   =        1.401]
#[Max     =       87.680, Total count    =       579656]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599440 requests in 5.00m, 611.84MB read
Requests/sec:   1998.09
Transfer/sec:      2.04MB
```

[get_cpu_old.html](get_cpu_old.html) </br>
[get_mem_old.html](get_mem_old.html) </br>
[get_lock_old.html](get_lock_old.html)

###### Освобождение селекторов
```
wrk2 -c128 -t4 -d5m -R1998 -L -s wrk/get.lua ht
tp://localhost:8080
Running 5m test @ http://localhost:8080
  4 threads and 128 connections
  Thread calibration: mean lat.: 1.413ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.418ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.398ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.398ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.36ms    1.02ms  77.50ms   96.83%
    Req/Sec   526.41    131.41     4.11k    71.98%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.29ms
 75.000%    1.66ms
 90.000%    2.01ms
 99.000%    2.79ms
 99.900%   10.07ms
 99.990%   50.01ms
 99.999%   67.46ms
100.000%   77.57ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.248     0.000000            1         1.00
       0.696     0.100000        57932         1.11
       0.868     0.200000       115840         1.25
       1.018     0.300000       174078         1.43
       1.157     0.400000       231685         1.67
       1.291     0.500000       289565         2.00
       1.358     0.550000       318841         2.22
       1.425     0.600000       347841         2.50
       1.495     0.650000       376773         2.86
       1.571     0.700000       405374         3.33
       1.657     0.750000       434647         4.00
       1.703     0.775000       448968         4.44
       1.753     0.800000       463364         5.00
       1.807     0.825000       477847         5.71
       1.866     0.850000       492302         6.67
       1.932     0.875000       506825         8.00
       1.969     0.887500       514097         8.89
       2.009     0.900000       521243        10.00
       2.053     0.912500       528571        11.43
       2.103     0.925000       535850        13.33
       2.161     0.937500       542929        16.00
       2.195     0.943750       546694        17.78
       2.231     0.950000       550159        20.00
       2.275     0.956250       553872        22.86
       2.323     0.962500       557507        26.67
       2.379     0.968750       561032        32.00
       2.415     0.971875       562915        35.56
       2.451     0.975000       564692        40.00
       2.493     0.978125       566445        45.71
       2.547     0.981250       568274        53.33
       2.609     0.984375       570060        64.00
       2.649     0.985938       570991        71.11
       2.695     0.987500       571857        80.00
       2.753     0.989062       572775        91.43
       2.825     0.990625       573680       106.67
       2.931     0.992188       574576       128.00
       3.013     0.992969       575024       142.22
       3.121     0.993750       575482       160.00
       3.259     0.994531       575929       182.86
       3.461     0.995313       576386       213.33
       3.745     0.996094       576832       256.00
       3.953     0.996484       577059       284.44
       4.251     0.996875       577286       320.00
       4.583     0.997266       577512       365.71
       5.079     0.997656       577737       426.67
       5.775     0.998047       577964       512.00
       6.215     0.998242       578077       568.89
       6.859     0.998437       578190       640.00
       7.847     0.998633       578303       731.43
       9.047     0.998828       578416       853.33
      10.247     0.999023       578529      1024.00
      10.983     0.999121       578587      1137.78
      12.063     0.999219       578642      1280.00
      13.471     0.999316       578699      1462.86
      15.023     0.999414       578755      1706.67
      17.119     0.999512       578812      2048.00
      18.239     0.999561       578840      2275.56
      19.919     0.999609       578868      2560.00
      21.647     0.999658       578897      2925.71
      24.735     0.999707       578925      3413.33
      29.359     0.999756       578953      4096.00
      30.335     0.999780       578967      4551.11
      35.423     0.999805       578981      5120.00
      38.815     0.999829       578996      5851.43
      42.815     0.999854       579010      6826.67
      46.335     0.999878       579024      8192.00
      49.279     0.999890       579031      9102.22
      50.687     0.999902       579038     10240.00
      52.511     0.999915       579045     11702.86
      54.911     0.999927       579052     13653.33
      57.855     0.999939       579059     16384.00
      58.975     0.999945       579063     18204.44
      59.519     0.999951       579066     20480.00
      60.415     0.999957       579070     23405.71
      60.863     0.999963       579073     27306.67
      62.591     0.999969       579077     32768.00
      63.423     0.999973       579079     36408.89
      63.487     0.999976       579080     40960.00
      63.967     0.999979       579082     46811.43
      65.727     0.999982       579084     54613.33
      66.559     0.999985       579086     65536.00
      67.391     0.999986       579087     72817.78
      67.391     0.999988       579087     81920.00
      67.455     0.999989       579088     93622.86
      68.991     0.999991       579089    109226.67
      73.599     0.999992       579090    131072.00
      73.855     0.999993       579091    145635.56
      73.855     0.999994       579091    163840.00
      73.855     0.999995       579091    187245.71
      73.983     0.999995       579092    218453.33
      73.983     0.999996       579092    262144.00
      74.431     0.999997       579093    291271.11
      74.431     0.999997       579093    327680.00
      74.431     0.999997       579093    374491.43
      74.431     0.999998       579093    436906.67
      74.431     0.999998       579093    524288.00
      77.567     0.999998       579094    582542.22
      77.567     1.000000       579094          inf
#[Mean    =        1.360, StdDeviation   =        1.020]
#[Max     =       77.504, Total count    =       579094]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599307 requests in 5.00m, 611.70MB read
Requests/sec:   1997.68
Transfer/sec:      2.04MB
```
[get_cpu.html](get_cpu.html) </br>
[get_mem.html](get_mem.html) </br>
[get_lock.html](get_lock.html)

Небольшое уменьшение максимального времени обработки запроса,
похожее на стохастическое.