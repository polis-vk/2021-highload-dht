# Нагрузочное тестирование утилитой wrk2

Параметры wrk2:

* время тестирования - 60 секунд
* количество открытых соединений - 1
* количество используемых потоков - 1
* количество запросов в секунду - 1000

## PUT-запросы:

```
$ wrk2 -c1 -t1 -d60s -R1000 -L -s 2021-highload-dht/src/main/resources/wrk-scripts/put_entity.lua http://localhost:8080
Running 1m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 2.837ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.32ms    5.88ms  54.94ms   95.83%
    Req/Sec     1.05k   472.48     6.89k    94.55%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.21ms
 75.000%    1.54ms
 90.000%    1.93ms
 99.000%   37.82ms
 99.900%   51.33ms
 99.990%   54.05ms
 99.999%   54.97ms
100.000%   54.97ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.089     0.000000            1         1.00
       0.579     0.100000         5020         1.11
       0.789     0.200000        10004         1.25
       0.966     0.300000        15033         1.43
       1.092     0.400000        20033         1.67
       1.211     0.500000        25012         2.00
       1.272     0.550000        27508         2.22
       1.332     0.600000        30007         2.50
       1.392     0.650000        32535         2.86
       1.456     0.700000        35007         3.33
       1.541     0.750000        37511         4.00
       1.598     0.775000        38762         4.44
       1.660     0.800000        40004         5.00
       1.725     0.825000        41247         5.71
       1.797     0.850000        42507         6.67
       1.857     0.875000        43758         8.00
       1.895     0.887500        44385         8.89
       1.932     0.900000        45007        10.00
       1.967     0.912500        45625        11.43
       2.004     0.925000        46255        13.33
       2.047     0.937500        46881        16.00
       2.073     0.943750        47190        17.78
       2.287     0.950000        47495        20.00
       6.443     0.956250        47807        22.86
      11.703     0.962500        48120        26.67
      17.327     0.968750        48432        32.00
      20.239     0.971875        48588        35.56
      23.087     0.975000        48745        40.00
      25.967     0.978125        48902        45.71
      28.959     0.981250        49057        53.33
      32.111     0.984375        49214        64.00
      33.695     0.985938        49291        71.11
      35.391     0.987500        49371        80.00
      36.895     0.989062        49449        91.43
      38.527     0.990625        49527       106.67
      40.223     0.992188        49605       128.00
      41.087     0.992969        49643       142.22
      42.015     0.993750        49683       160.00
      42.943     0.994531        49722       182.86
      43.807     0.995313        49760       213.33
      44.927     0.996094        49800       256.00
      45.567     0.996484        49819       284.44
      46.271     0.996875        49838       320.00
      46.975     0.997266        49858       365.71
      47.807     0.997656        49877       426.67
      48.735     0.998047        49897       512.00
      49.311     0.998242        49907       568.89
      49.727     0.998437        49917       640.00
      50.335     0.998633        49926       731.43
      50.815     0.998828        49936       853.33
      51.391     0.999023        49946      1024.00
      51.583     0.999121        49951      1137.78
      51.743     0.999219        49955      1280.00
      52.159     0.999316        49960      1462.86
      52.351     0.999414        49966      1706.67
      52.639     0.999512        49970      2048.00
      52.799     0.999561        49973      2275.56
      53.087     0.999609        49975      2560.00
      53.151     0.999658        49977      2925.71
      53.279     0.999707        49980      3413.33
      53.375     0.999756        49982      4096.00
      53.631     0.999780        49984      4551.11
      53.791     0.999805        49985      5120.00
      53.919     0.999829        49986      5851.43
      53.951     0.999854        49987      6826.67
      54.015     0.999878        49988      8192.00
      54.047     0.999890        49989      9102.22
      54.111     0.999902        49990     10240.00
      54.111     0.999915        49990     11702.86
      54.271     0.999927        49991     13653.33
      54.271     0.999939        49991     16384.00
      54.495     0.999945        49992     18204.44
      54.495     0.999951        49992     20480.00
      54.495     0.999957        49992     23405.71
      54.879     0.999963        49993     27306.67
      54.879     0.999969        49993     32768.00
      54.879     0.999973        49993     36408.89
      54.879     0.999976        49993     40960.00
      54.879     0.999979        49993     46811.43
      54.975     0.999982        49994     54613.33
      54.975     1.000000        49994          inf
#[Mean    =        2.318, StdDeviation   =        5.875]
#[Max     =       54.944, Total count    =        49994]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  59999 requests in 1.00m, 4.23MB read
Requests/sec:    999.99
Transfer/sec:     72.26KB

```

### Максимальное время ответа на запрос для различных доверительных интервалов:

* `75.000% - 1.54ms`  - запросы при выполнении которых не происходит перезапись базы данных из оперативной памяти на диск
* `99.000% - 37.82ms` - запросы при выполнении которых происходит перезапись базы данных из оперативной памяти на диск
* `99.990% - 63.90ms` - предположительно, запись на диск элементов базы, которые занимают большее число байт
  (следствие инкремента счетчика в скрипте [put_entity.lua](../../wrk-scripts/put_entity.lua)]), либо стохастика времени выполнения системного вызова записи в файл в операционной системе(все-таки сервер работает не на операционной системе реального времени).
* `99.999% - 63.90ms` - аналогично интервалу до `99.990%`

## GET-запросы:

```
$ wrk2 -c1 -t1 -d60s -R1000 -L -s 2021-highload-dht/src/main/resources/wrk-scripts/get_entity.lua http://localhost:8080
Running 1m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.624ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.20ms  839.37us  33.60ms   96.85%
    Req/Sec     1.06k   107.37     4.67k    88.80%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.15ms
 75.000%    1.44ms
 90.000%    1.65ms
 99.000%    2.41ms
 99.900%   13.23ms
 99.990%   29.79ms
 99.999%   33.63ms
100.000%   33.63ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.118     0.000000            1         1.00
       0.637     0.100000         5015         1.11
       0.771     0.200000        10003         1.25
       0.900     0.300000        15012         1.43
       1.029     0.400000        20014         1.67
       1.150     0.500000        25029         2.00
       1.207     0.550000        27520         2.22
       1.264     0.600000        30001         2.50
       1.322     0.650000        32499         2.86
       1.381     0.700000        35016         3.33
       1.443     0.750000        37495         4.00
       1.476     0.775000        38774         4.44
       1.508     0.800000        40001         5.00
       1.539     0.825000        41283         5.71
       1.574     0.850000        42510         6.67
       1.610     0.875000        43773         8.00
       1.627     0.887500        44379         8.89
       1.646     0.900000        45013        10.00
       1.670     0.912500        45624        11.43
       1.703     0.925000        46249        13.33
       1.762     0.937500        46875        16.00
       1.793     0.943750        47185        17.78
       1.831     0.950000        47497        20.00
       1.875     0.956250        47808        22.86
       1.926     0.962500        48121        26.67
       1.986     0.968750        48435        32.00
       2.017     0.971875        48596        35.56
       2.053     0.975000        48747        40.00
       2.087     0.978125        48902        45.71
       2.125     0.981250        49062        53.33
       2.169     0.984375        49217        64.00
       2.195     0.985938        49290        71.11
       2.245     0.987500        49369        80.00
       2.321     0.989062        49447        91.43
       2.523     0.990625        49525       106.67
       2.843     0.992188        49603       128.00
       3.089     0.992969        49642       142.22
       3.469     0.993750        49681       160.00
       3.857     0.994531        49720       182.86
       4.367     0.995313        49759       213.33
       5.091     0.996094        49798       256.00
       5.539     0.996484        49818       284.44
       6.071     0.996875        49838       320.00
       6.619     0.997266        49858       365.71
       7.559     0.997656        49876       426.67
       8.527     0.998047        49896       512.00
       9.367     0.998242        49906       568.89
      10.095     0.998437        49915       640.00
      10.975     0.998633        49925       731.43
      12.143     0.998828        49935       853.33
      13.311     0.999023        49945      1024.00
      14.103     0.999121        49950      1137.78
      14.727     0.999219        49954      1280.00
      15.135     0.999316        49959      1462.86
      15.807     0.999414        49964      1706.67
      17.327     0.999512        49969      2048.00
      18.271     0.999561        49972      2275.56
      18.783     0.999609        49974      2560.00
      19.839     0.999658        49976      2925.71
      22.287     0.999707        49979      3413.33
      23.935     0.999756        49981      4096.00
      25.615     0.999780        49983      4551.11
      26.447     0.999805        49984      5120.00
      27.279     0.999829        49985      5851.43
      28.111     0.999854        49986      6826.67
      28.943     0.999878        49987      8192.00
      29.791     0.999890        49988      9102.22
      30.623     0.999902        49989     10240.00
      30.623     0.999915        49989     11702.86
      31.455     0.999927        49990     13653.33
      31.455     0.999939        49990     16384.00
      32.239     0.999945        49991     18204.44
      32.239     0.999951        49991     20480.00
      32.239     0.999957        49991     23405.71
      32.959     0.999963        49992     27306.67
      32.959     0.999969        49992     32768.00
      32.959     0.999973        49992     36408.89
      32.959     0.999976        49992     40960.00
      32.959     0.999979        49992     46811.43
      33.631     0.999982        49993     54613.33
      33.631     1.000000        49993          inf
#[Mean    =        1.197, StdDeviation   =        0.839]
#[Max     =       33.600, Total count    =        49993]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  59998 requests in 1.00m, 238.09MB read
Requests/sec:    999.97
Transfer/sec:      3.97MB

```

### Максимальное время ответа на запрос для различных доверительных интервалов:

* `75.000% - 1.60ms`  - различная скорость поиска нужного id в списке объектов SSTable(особого скачка не наблюдается)
* `99.000% - 2.22ms`  - различная скорость поиска нужного id в списке объектов SSTable(особого скачка не наблюдается)
* `99.990% - 6.99ms`  - по моим подсчетам, 50 запросов из 60_000. Предположительно, стохастика операции поиска элемента в коллекции ConcurrentSkipListMap.
* `99.999% - 9.07ms`  - по моим подсчетам, 5 запросов из 60_000. Предположительно, то же что для случая `99.99%`
# Профилирование с помощью async-profiler

## PUT-запросы:

### Профилирование CPU
[put_cpu.html](profiling/put_cpu.html)

####Наблюдения
* большую часть процессорных ресурсов занимает метод `LSMDao.upsert(..)` - `18.36%`, причем на следующем уровне стека
  `13.27%` используется методом `LsmDAO.flush(..)` (запись на диск) и `5.09%` методом `ConcurrentSkipListMap.put(..)`(запись в оперативную памяти)


### Профилирование RAM
[put_mem.html](profiling/put_mem.html)

####Наблюдения
* Функция добавления записи в базу данных `DaoWrapper.putEntity(..)` использует `28.13%` ресурсов оперативной памяти. 
Наиболее ресурсозатратной функцией на более глубоком уровне стека является функция записи в базу `LsmDAO.upsert(..)`
, на которую приходится 7.29% выделений оперативной памяти
* Функция записи ответа на запрос `HttpSession.writeResponse(..)` использует `11.46%` ресурсов оперативной памяти

## GET-запросы:
### Профилирование CPU
[get_cpu.html](profiling/get_cpu.html)

####Наблюдения
* большую часть процессорных ресурсов занимает метод `LSMDao.range(..)` - `58.19`, причем на следующем уровне стека
`55.22%` используется методом `LsmDAO.SSTableRanges(..)` (чтение с диска) и лишь `3%` методами объекта `ConcurrentSkipListMap`(чтение в оперативной памяти)

### Профилирование RAM
[get_mem.html](profiling/get_mem.html)

####Наблюдения
* Чтение из базы данных `LsmDAO.range(..)` использует `22.86%` ресурсов оперативной памяти
* Запись ответа на запрос `HttpSession.writeResponse(..)` использует `17.4%` ресурсов оперативной памяти


## Чего бы оптимзировать
* увеличить размер параметра `DAOConfig.DEFAULT_MEMORY_LIMIT`, чтобы работать с меньшим числом объектов SSTable, а также реже записывать данные на диск
* распараллелить процесс обработки запросов при помощи пула потоков
* производить запись данных в файл асинхронно, например при помощи класса `AsynchronousFileChannel`
* рассмотреть альтернативные коллекции для хранения последних 4 Мбайт базы данных